name: Deploy Worker Script

on:
  push:
    tags:
      - '*'  # 当任何标签被推送时触发

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get tag name
        id: get_tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "当前标签: $TAG_NAME"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整的Git历史来获取标签信息
      
      - name: Check if source file exists
        run: |
          if [ ! -f "worker_obfuscated.js" ]; then
            echo "Error: 'worker_obfuscated.js' not found in root directory."
            exit 1
          fi
          echo "Found source file 'worker_obfuscated.js'"
      
      - name: Rename file to _worker.js
        run: |
          cp "worker_obfuscated.js" "_worker.js"
          echo "Successfully copied 'worker_obfuscated.js' to '_worker.js'"
          echo "Note: This file is not committed, only used for Release"
      
      - name: Create zip file
        run: |
          zip Pages.zip _worker.js
          echo "Successfully compressed '_worker.js' to 'Pages.zip'"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Pages ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## Deployment Info
            
            - **Source**: worker_obfuscated.js
            - **Target**: _worker.js
            - **Archive**: Pages.zip
            - **Tag**: ${{ steps.get_tag.outputs.tag_name }}
            - **Time**: ${{ github.event.head_commit.timestamp }}
            
            ## Changes
            
            Generated `_worker.js` from `worker_obfuscated.js` and compressed to `Pages.zip`.
          draft: false
          prerelease: false
          files: Pages.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Output summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Source: worker_obfuscated.js" >> $GITHUB_STEP_SUMMARY
          echo "- Target: _worker.js" >> $GITHUB_STEP_SUMMARY
          echo "- 压缩文件: Pages.zip" >> $GITHUB_STEP_SUMMARY
          echo "- 标签: ${{ steps.get_tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release 已创建" >> $GITHUB_STEP_SUMMARY
