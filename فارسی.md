# CFnew - ترمینال v2.9.3

**زبان:** [中文](README.md) | [فارسی](فارسی.md)

[گروه تلگرام](https://t.me/+ft-zI76oovgwNmRh)

## فهرست مطالب
1. [ویژگی‌های اصلی](#ویژگی‌های-اصلی)
2. [به‌روزرسانی‌ها](#به‌روزرسانی-v293)
3. [ابزارهای مرتبط](#ابزارهای-مرتبط)
4. [استقرار و پیکربندی](#استقرار)
   - [پیکربندی پایه](#پیکربندی-پایه)
   - [پیکربندی پروتکل](#پیکربندی-پروتکل)
   - [پیکربندی گرافیکی](#پیکربندی-گرافیکی-توصیه-می‌شود)
   - [کنترل پیشرفته](#کنترل-پیشرفته)
   - [تنظیمات KV](#تنظیمات-kv-توصیه-می‌شود)
5. [استفاده از API](#استفاده-از-api)
6. [DoH پروکسی](#doh-پروکسی)
7. [واژه‌نامه و اصطلاحات](#واژه‌نامه-و-اصطلاحات-فنی)
8. [توضیحات عملکرد](#توضیحات-عملکرد)
9. [تاریخچه ستاره](#تاریخچه-ستاره)

---

## ویژگی‌های اصلی

- **پشتیبانی چند پروتکل**: VLESS، Trojan، xhttp، VMess، Shadowsocks، gRPC؛ می‌توانید همزمان چند پروتکل را فعال کنید.
- **مسیر سفارشی**: امکان تنظیم مسیر دلخواه (به جای UUID) با پشتیبانی از مسیرهای چند سطحی.
- **تست تاخیر**: ابزار داخلی برای تست تاخیر سرور (IP) و دریافت خودکار کد فرودگاه.
- **تبدیل اشتراک (Subscription Convert)**: امکان تنظیم آدرس سرویس تبدیل اشتراک شخصی.
- **مدیریت گرافیکی**: ذخیره‌سازی تنظیمات در KV با اعمال آنی تغییرات بدون نیاز به استقرار مجدد.
- **مدیریت API**: مدیریت سرورهای ترجیحی (Preferred IPs) از طریق RESTful API.
- **DoH داخلی**: سرویس DNS-over-HTTPS داخلی با کارایی بالا.
- **پشتیبانی چند کلاینت**: CLASH، SURGE، SING-BOX، LOON، QUANTUMULT X، V2RAY، Shadowrocket، STASH، NEKORAY، V2RAYNG.
- **بیدار کردن برنامه**: باز کردن خودکار نرم‌افزار کلاینت با کلیک روی دکمه.
- **تشخیص خودکار**: بازگرداندن فرمت مناسب بر اساس User-Agent کاربر.
- **پشتیبانی چند زبان**: تغییر خودکار بین چینی و فارسی بر اساس زبان مرورگر با پشتیبانی کامل RTL.

## به‌روزرسانی v2.9.4 (جدید)

- **گسترش پروتکل‌ها**: اضافه شدن پشتیبانی از VMess، Shadowsocks، TUIC، Hysteria 2 و VLESS gRPC.
- **سرویس DoH**: اضافه شدن پروکسی DNS-over-HTTPS داخلی با قابلیت لود بالانسینگ و حذف تبلیغات.

## به‌روزرسانی v2.9.3

- **ویژگی جدید سفارشی‌سازی DNS و دامنه ECH در رابط گرافیکی**
  - امکان تنظیم دستی آدرس سرور DNS (فرمت DoH).
  - امکان تنظیم دستی دامنه ECH.
  - اعمال تغییرات به صورت پویا و آنی.
  - اضافه شدن پارامتر `query-server-name` به `ech-opts` در پیکربندی Clash برای هماهنگی با v2ray.

## به‌روزرسانی v2.9

- **فیلتر منطقه**: فیلتر کردن نتایج ترجیحی بر اساس منطقه با قابلیت انتخاب چندگانه.
- **فیلتر تاخیر**: گزینه جدید "فقط نمایش ۱۰ مورد سریع‌ترین".
- **حالت اضافه/جایگزین**: امکان افزودن نتایج به لیست موجود یا جایگزینی کامل لیست.
- **بهینه‌سازی نمایش**: نمایش برچسب منطقه و مرتب‌سازی بر اساس تاخیر.

## ابزارهای مرتبط

- ابزار ترجیحی: [GitHub Releases](https://github.com/byJoey/yx-tools/releases)
- آموزش متنی: [joeyblog.net](https://joeyblog.net/yuanchuang/1146.html)
- آموزش ویدیویی Workers: [YouTube](https://www.youtube.com/watch?v=aYzTr8FafN4)
- آموزش ویدیویی Pages: [YouTube](https://www.youtube.com/watch?v=JhVxJChDL-E)
- آموزش ویدیویی Snippets: [YouTube](https://www.youtube.com/watch?v=xeFeH3Akcu8)

## استقرار

اشتراک هر ۱۵ دقیقه یکبار به صورت خودکار سرورها را انتخاب می‌کند.

### پیکربندی پایه

<div dir="rtl">

| نام متغیر | مقدار | توضیحات |
| :--- | :--- | :--- |
| `u` | UUID شما | **الزامی**. برای دسترسی به پنل اشتراک و مدیریت. |
| `p` | proxyip | **اختیاری**. آدرس و پورت ProxyIP سفارشی. |
| `s` | آدرس SOCKS5 | **اختیاری**. فرمت: `user:pass@host:port` یا `host:port`. |
| `d` | مسیر سفارشی | **اختیاری**. مثال: `/mypath` یا `/path/to/sub`. در صورت خالی بودن از UUID استفاده می‌شود. |
| `wk` | کد منطقه | **اختیاری**. مثال: `SG`، `HK`، `US`، `JP`. |

</div>

### پیکربندی پروتکل

<div dir="rtl">

| نام متغیر | مقدار | توضیحات |
| :--- | :--- | :--- |
| `ev` | yes/no | **اختیاری**. فعال‌سازی VLESS (پیش‌فرض: فعال). |
| `et` | yes/no | **اختیاری**. فعال‌سازی Trojan (پیش‌فرض: غیرفعال). |
| `ex` | yes/no | **اختیاری**. فعال‌سازی xhttp (پیش‌فرض: غیرفعال). |
| `evm` | yes/no | **اختیاری**. فعال‌سازی VMess (پیش‌فرض: غیرفعال). |
| `ess` | yes/no | **اختیاری**. فعال‌سازی Shadowsocks (پیش‌فرض: غیرفعال). |
| `etu` | yes/no | **اختیاری**. فعال‌سازی TUIC (فقط تولید لینک). |
| `ehy` | yes/no | **اختیاری**. فعال‌سازی Hysteria 2 (فقط تولید لینک). |
| `eg` | yes/no | **اختیاری**. فعال‌سازی VLESS gRPC. |
| `tp` | رمز عبور | **اختیاری**. رمز عبور Trojan (در صورت خالی بودن از UUID استفاده می‌شود). |

</div>

### پیکربندی گرافیکی (توصیه می‌شود)

1. در بخش Workers داشبورد کلودفلر، یک **فضای نام KV (KV Namespace)** ایجاد کنید و متغیر محیطی `C` را به آن متصل کنید.
2. پس از استقرار، به آدرس `/{UUID}` بروید تا وارد پنل مدیریت گرافیکی شوید.
3. تغییرات در این پنل بلافاصله اعمال می‌شوند.

### کنترل پیشرفته

<div dir="rtl">

| نام متغیر | مقدار | توضیحات |
| :--- | :--- | :--- |
| `yx` | IP/دامنه ترجیحی | **اختیاری**. فرمت: `1.1.1.1:443#سرور هنگ‌کنگ,8.8.8.8:53#Google DNS`. |
| `yxURL` | URL منبع IP | **اختیاری**. لینک لیست IPهای ترجیحی (پیش‌فرض دارد). |
| `scu` | آدرس تبدیل | **اختیاری**. آدرس سرویس تبدیل اشتراک (پیش‌فرض: `https://url.v1.mk/sub`). |
| `epd` | yes/no | **اختیاری**. فعال‌سازی دامنه ترجیحی (پیش‌فرض: فعال). |
| `epi` | yes/no | **اختیاری**. فعال‌سازی IP ترجیحی (پیش‌فرض: فعال). |
| `egi` | yes/no | **اختیاری**. فعال‌سازی ترجیح GitHub (پیش‌فرض: فعال). |
| `qj` | no | **اختیاری**. فعال‌سازی کاهش سطح (Fallback): CF مستقیم -> SOCKS5 -> Fallback. |
| `dkby` | yes | **اختیاری**. اگر `yes` باشد، فقط سرورهای TLS تولید می‌شوند. |
| `yxby` | yes | **اختیاری**. اگر `yes` باشد، تمام عملکردهای ترجیحی خاموش می‌شوند. |
| `rm` | no | **اختیاری**. خاموش کردن تطبیق هوشمند منطقه. |
| `ae` | yes | **اختیاری**. فعال‌سازی مدیریت API (پیش‌فرض: خاموش). |

</div>

### تنظیمات KV (توصیه می‌شود)

1. در Cloudflare Workers یک **KV Namespace** ایجاد کنید.
2. در تنظیمات Worker خود، KV ایجاد شده را متصل کنید و نام متغیر (Variable Name) را `C` قرار دهید.
3. Worker را مجدداً Deploy کنید.
4. به آدرس `/{UUID}` مراجعه کنید.

## استفاده از API

برای استفاده از API، ابتدا باید گزینه "اجازه مدیریت API" را در پنل گرافیکی فعال و ذخیره کنید.

1. **نرم‌افزار مدیریت**: [دانلود ابزار](https://github.com/byJoey/yx-tools/releases)
2. **فعال‌سازی**: به پنل وب (`/{UUID}` یا `/{مسیر سفارشی}`) بروید و گزینه مربوطه را فعال کنید.

### مثال‌های درخواست API

**افزودن یک سرور (IP):**
```bash
# استفاده از مسیر UUID
curl -X POST "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4", "port": 443, "name": "سرور هنگ‌کنگ"}'
```

**افزودن گروهی سرورها:**
```bash
curl -X POST "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '[
    {"ip": "1.2.3.4", "port": 443, "name": "سرور 1"},
    {"ip": "5.6.7.8", "port": 8443, "name": "سرور 2"}
  ]'
```

**حذف یک سرور خاص:**
```bash
curl -X DELETE "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4", "port": 443}'
```

**پاک‌سازی تمام سرورها:**
```bash
curl -X DELETE "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '{"all": true}'
```

## DoH پروکسی

این اسکریپت اکنون شامل یک پروکسی DNS-over-HTTPS (DoH) داخلی است که برای بهبود حریم خصوصی و دور زدن فیلترینگ DNS مفید است.

- **آدرس**: `https://your-worker.workers.dev/dns-query`
- **ویژگی‌ها**:
  - لود بالانسینگ بین چندین ارائه‌دهنده (Cloudflare, Google, Quad9 و...).
  - پشتیبانی از DNSهای ضد تبلیغات (AdGuard, NextDNS).
  - کش کردن پاسخ‌ها برای سرعت بیشتر.
  - پشتیبانی از درخواست‌های GET و POST استاندارد (RFC 8484).

## واژه‌نامه و اصطلاحات فنی

برای درک بهتر تنظیمات، تعاریف زیر را مطالعه کنید:

- **فضای نام KV (KV Namespace)**: نوعی پایگاه دادهٔ کلید-مقدار (Key-Value) در پلتفرم Cloudflare Workers است که برای ذخیره‌سازی تنظیمات و اعمال تغییرات بدون نیاز به تغییر کد استفاده می‌شود.
- **Workers**: پلتفرم بدون سرور (Serverless) شرکت Cloudflare که این اسکریپت روی آن اجرا می‌شود.
- **User-Agent**: شناسه‌ای که نوع مرورگر یا نرم‌افزار کلاینت (مانند v2rayNG یا Clash) را به سرور اعلام می‌کند تا فرمت اشتراک مناسب ارسال شود.
- **ECH (Encrypted Client Hello)**: قابلیت رمزنگاری "سلام اولیه" در ارتباطات TLS. این ویژگی باعث می‌شود دامنه‌ی مقصد (SNI) رمزگذاری شده و از دید فیلترینگ مخفی بماند.

## توضیحات عملکرد

### تست تاخیر
ابزار داخلی برای بررسی سرعت اتصال به IPها. این ابزار زمان DNS و دست‌دهی TLS را کسر کرده و تاخیر واقعی را نمایش می‌دهد.

### پشتیبانی چند پروتکل
- **VLESS**: پروتکل سبک و استاندارد (پیش‌فرض).
- **Trojan**: پروتکل امن با پشتیبانی از رمز عبور (Trojan-WS-TLS).
- **xhttp**: پروتکل استتار مبتنی بر HTTP POST.
- **پروتکل‌های جدید**: VMess, Shadowsocks, TUIC, Hysteria 2, VLESS gRPC.

### مسیر سفارشی (متغیر d)
امنیت بیشتر با مخفی کردن UUID. می‌توانید مسیری مانند `/my-secret-path` تنظیم کنید.

### پشتیبانی چند زبان
پنل مدیریت به صورت هوشمند زبان مرورگر شما را تشخیص داده و بین فارسی (با چیدمان راست‌به‌چپ) و چینی سوئیچ می‌کند.

### مدیریت پیکربندی
تنظیمات در KV ذخیره می‌شوند و اولویت آن‌ها به این صورت است: تنظیمات KV > متغیرهای محیطی > مقادیر پیش‌فرض.

### وضعیت سیستم
نمایش منطقه فعلی Worker و وضعیت ProxyIP. انتخاب سرور بر اساس منطق: هم‌منطقه → منطقه مجاور → سایر مناطق انجام می‌شود.

## تاریخچه ستاره

[![نمودار تاریخچه ستاره‌های پروژه در گیت‌هاب](https://api.star-history.com/svg?repos=byJoey/cfnew&type=Timeline)](https://www.star-history.com/#byJoey/cfnew&Timeline&LogScale)

---
*تشکر ویژه از پروژه‌های [zizifn/edgetunnel](https://github.com/zizifn/edgetunnel)، [cmliu](https://github.com/cmliu) و [qwer-search](https://github.com/qwer-search).*
