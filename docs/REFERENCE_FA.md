# مرجع کامل CFnew

این سند، مرجع کامل پروژه است: مسیرها، متغیرها، APIها، گزینه‌های UI و فرمت‌ها.

---

## ۱) کدام فایل را دیپلوی کنم؟

- `worker.js` (پیشنهادی): کد اصلی Worker (خوانا)


---

## ۲) نقشه مسیرها (همهٔ مسیرها)

در ادامه، `<ACCESS>` یعنی **مسیر UUID** یا **مسیر سفارشی `d`**.

| مسیر | کاربرد | توضیح |
|---|---|---|
| `/` | صفحه ترمینال | اگر `homepage` تنظیم شود، همان صفحه نمایش داده می‌شود. |
| `/<UUID>` | داشبورد | فقط وقتی `d` خالی است. |
| `/<CUSTOM_PATH>` | داشبورد | وقتی `d` تنظیم شده باشد. |
| `/<ACCESS>/sub` | خروجی اشتراک | با `?target=` فرمت عوض می‌شود. |
| `/<ACCESS>/region` | JSON منطقه | برای System Status داشبورد. |
| `/<ACCESS>/api/config` | API تنظیمات | GET/POST؛ نیازمند KV با نام `C`. |
| `/<ACCESS>/api/preferred-ips` | API IPهای ترجیحی | GET/POST/DELETE؛ نیازمند `ae=yes`. |
| `/dns-query` | پراکسی DoH | GET با `?dns=` یا POST باینری DNS. |
| `/dns-encoding` | توضیح DoH | متن کوتاه دربارهٔ انکودینگ. |

---

## ۳) قواعد دسترسی

- `u` (UUID) الزامی است.
- با تنظیم `d`، مسیر UUID **غیرفعال** می‌شود و فقط `/<CUSTOM_PATH>` معتبر است.
- همهٔ APIها باید از مسیر صحیح `<ACCESS>` فراخوانی شوند.

---

## ۴) اولویت تنظیمات (مهم)

- تنظیمات KV در کلید `c` ذخیره می‌شود (binding با نام `C`).
- ترتیب خواندن: **KV اولویت دارد**، سپس متغیرهای محیطی.
- داشبورد همیشه روی KV می‌نویسد.
- «Reset» KV را پاک می‌کند و به env برمی‌گردد.

### ۴.۱ حروف بزرگ در env

بیشتر کلیدها نسخهٔ **حروف بزرگ** هم دارند (مثل `U`, `D`, `P`, `S`, `WK`, `YX`, `YXURL`, `RM`, `QJ`, `DKBY`, `YXBY`, `HOMEPAGE`).
در داشبورد/API از کلیدهای کوچک استفاده کنید.

---

## ۵) مرجع کامل متغیرها

### ۵.۱ دسترسی و مسیرها

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `u` | UUID | الزامی | کلید دسترسی شما. |
| `d` | `/path` | خالی | مسیر سفارشی داشبورد (UUID را غیرفعال می‌کند). |
| `wk` | کد منطقه | خالی | تعیین دستی منطقه Worker (مثل `US`, `SG`). |
| `p` | `host:port` | خالی | ProxyIP سفارشی؛ انتخاب منطقه را غیرفعال می‌کند. |
| `s` | `user:pass@host:port` | خالی | پراکسی SOCKS5 بالادست. |
| `homepage` | URL | خالی | جایگزینی صفحه `/` با صفحه جعلی. |

### ۵.۲ سوییچ پروتکل‌ها

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `ev` | `yes/no` | `yes` | نودهای VLESS WS. |
| `et` | `yes/no` | `no` | نودهای Trojan WS. |
| `ex` | `yes/no` | `no` | نودهای xhttp (HTTP POST). |
| `evm` | `yes/no` | `no` | لینک‌های VMess (فقط لینک). |
| `ess` | `yes/no` | `no` | لینک‌های Shadowsocks (فقط لینک). |
| `etu` | `yes/no` | `no` | لینک‌های TUIC (فقط لینک). |
| `ehy` | `yes/no` | `no` | لینک‌های Hysteria2 (فقط لینک). |
| `eg` | `yes/no` | `no` | لینک‌های VLESS gRPC (فقط لینک). |
| `tp` | رشته | خالی | رمز Trojan (خالی = UUID). |

نکته‌ها:
- پروتکل‌های «فقط لینک» نیاز به بک‌اند خارجی دارند.
- مسیر xhttp برابر `/<۸ کاراکتر اول UUID>` است.
- gRPC معمولاً به دامنهٔ سفارشی نیاز دارد.

### ۵.۳ لیست‌های ترجیحی و منابع

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `yx` | لیست | خالی | لیست IP ترجیحی دستی (اولویت بالا). |
| `yxURL` | URL | پیش‌فرض GitHub | دریافت لیست ترجیحی از URL. |
| `epd` | `yes/no` | `no` | فعال‌سازی دامنه‌های ترجیحی. |
| `epi` | `yes/no` | `yes` | فعال‌سازی IPهای ترجیحی. |
| `egi` | `yes/no` | `yes` | فعال‌سازی لیست پیش‌فرض GitHub. |
| `yxby` | `yes` | خاموش | غیرفعال‌کردن همه ترجیحی‌ها. |

### ۵.۴ کارایی و فیلترها

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `rm` | `no` | فعال | `no` تطبیق منطقه را غیرفعال می‌کند. |
| `qj` | `no` | غیرفعال | `no` حالت کاهش سطح را فعال می‌کند (مستقیم → SOCKS5 → فالبک). |
| `dkby` | `yes` | خاموش | `yes` همه پورت‌های غیر‑TLS را حذف می‌کند. |
| `edp` | `yes` | خاموش | تولید همه پورت‌های CF برای هر IP. |
| `ipv4` | `yes/no` | فعال | فقط IPv4 در لیست‌ها. |
| `ipv6` | `yes/no` | فعال | فقط IPv6 در لیست‌ها. |
| `ispMobile` | `yes/no` | فعال | فقط ISP موبایل. |
| `ispUnicom` | `yes/no` | فعال | فقط ISP یونیکام. |
| `ispTelecom` | `yes/no` | فعال | فقط ISP تلکام. |

نکته:
- فیلترهای `ipv4/ipv6/isp*` فقط روی لیست‌های دریافت‌شده از URL اعمال می‌شوند.
- با فعال‌سازی ECH، مقدار `dkby=yes` به‌طور خودکار در KV ثبت می‌شود.

### ۵.۵ ECH

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `ech` | `yes/no` | خاموش | افزودن ECH به لینک‌های اشتراک. |
| `customDNS` | URL DoH | DoH پیش‌فرض | سرور DoH برای ECH. |
| `customECHDomain` | دامنه | `cloudflare-ech.com` | دامنه ECH. |

### ۵.۶ API و تبدیل اشتراک

| کلید | مقدار | پیش‌فرض | توضیح |
|---|---|---|---|
| `ae` | `yes/no` | خاموش | فعال‌سازی `/api/preferred-ips`. |
| `scu` | URL | `https://url.v1.mk/sub` | آدرس سرویس تبدیل اشتراک. |
| `rcu` | URL | پیش‌فرض داخلی | آدرس تنظیمات کانورتور (جایگزین پیش‌فرض). |

---

## ۶) فرمت‌های خروجی اشتراک

`/<ACCESS>/sub` با `?target=` (بدون حساسیت به حروف):

- `base64` (پیش‌فرض)
- `clash`, `clashr`
- `surge`, `surge2`, `surge3`, `surge4`
- `quantumult`, `quanx`
- `ss`, `ssr`
- `v2ray`
- `loon`

نکته: فرایند تبدیل در داشبورد از `REMOTE_CONFIG_URL` داخلی استفاده می‌کند. شما می‌توانید با متغیر `rcu` (env یا KV) آن را تغییر دهید.

هدرهای ECH:
- `X-ECH-Status: ENABLED`
- `X-ECH-Config-Length: <length>`

---

## ۷) API تنظیمات

تمام APIها باید از مسیر صحیح `<ACCESS>` فراخوانی شوند و KV `C` فعال باشد.

### ۷.۱ GET `/<ACCESS>/api/config`

پیکربندی KV را همراه با `kvEnabled: true` برمی‌گرداند.

### ۷.۲ POST `/<ACCESS>/api/config`

- بدنه: JSON با کلیدهای تنظیمات.
- مقدار خالی / null یعنی حذف آن کلید.
- خروجی: `{ success, message, config }`.

### ۷.۳ GET `/<ACCESS>/api/preferred-ips`

نیازمند `ae=yes`.

### ۷.۴ POST `/<ACCESS>/api/preferred-ips`

نیازمند `ae=yes`.

نمونه:
```json
{ "ip": "1.1.1.1", "port": 443, "name": "MyNode" }
```

### ۷.۵ DELETE `/<ACCESS>/api/preferred-ips`

نیازمند `ae=yes`.

- پاک‌کردن همه:
```json
{ "all": true }
```

- حذف یک مورد:
```json
{ "ip": "1.1.1.1", "port": 443 }
```

---

## ۸) فرمت لیست‌های ترجیحی

### ۸.۱ `yx` (دستی)

- جداشده با کاما یا خط جدید.
- فرمت: `IP:PORT#Remark`
- IPv6 باید داخل `[ ]` باشد.

مثال:
```
1.1.1.1:443#HK
[2606:4700:4700::1111]:443#IPv6
```

### ۸.۲ `yxURL` (لیست از URL)

فرمت‌های پشتیبانی‌شده:

1) متن ساده
```
1.1.1.1
1.1.1.2:443#HK
```
- اگر پورت نبود، از `?port=` یا 443 استفاده می‌شود.

2) CSV با سربرگ چینی
- `IP地址,端口,数据中心` (یا `国家` / `城市`)
- اگر ستون `TLS` وجود داشته باشد، فقط مقدار `true` پذیرفته می‌شود.

3) CSV با تأخیر و سرعت
- شامل ستون‌های `IP` + `延迟` + `下载速度`

اگر `yxURL` از آدرس پیش‌فرض GitHub تغییر کند، لیست‌های داخلی پاک می‌شوند تا لیست شما مرجع اصلی باشد.

---

## ۹) DoH

`/dns-query` یک پراکسی DoH با چند ارائه‌دهنده است.

- GET: `?dns=<base64url>`
- POST: پیام خام DNS

`/dns-encoding` توضیح کوتاه انکودینگ را برمی‌گرداند.

---

## ۱۰) گزینه‌های UI (کامل)

داشبورد تمام گزینه‌های اصلی را پوشش می‌دهد:

- سوییچ پروتکل‌ها (`ev`, `et`, `ex`, `evm`, `ess`, `etu`, `ehy`, `eg`)
- ECH + DoH + دامنه ECH
- مسیر سفارشی، ProxyIP، SOCKS5، صفحه جعلی
- لیست ترجیحی (`yx`) و منبع URL (`yxURL`)
- فیلترهای ترجیحی (IPv4/IPv6، ISP)
- تولید چندپورتی (`edp`)
- تطبیق منطقه (`rm`)، کاهش سطح (`qj`)، فقط TLS (`dkby`)، غیرفعال‌کردن ترجیحی (`yxby`)
- مدیریت API (`ae`)

---

## ۱۱) کنسول دیباگ

کنسول داخلی UI این موارد را ثبت می‌کند:
- خطاهای JS
- Promiseهای مدیریت‌نشده
- `console.log/info/debug/warn/error`

در صورت خطا/هشدار به‌صورت خودکار باز می‌شود.

---

## ۱۲) نکات امنیتی کوتاه

- UUID را محرمانه نگه دارید.
- مسیر سفارشی `d` را ترجیح دهید.
- داشبورد را با Cloudflare Access یا allowlist محافظت کنید.
- در صورت افشا، UUID را تغییر دهید.

---

برای توضیحات مفهومی و مراحل کامل، به `docs/WALKTHROUGH_FA.md` و `docs/DEPLOYMENT_FA.md` مراجعه کنید.
