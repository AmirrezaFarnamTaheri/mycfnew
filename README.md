# CFnew - ç»ˆç«¯ v2.9.3

**è¯­è¨€:** [ä¸­æ–‡](README.md) | [ÙØ§Ø±Ø³ÛŒ](ÙØ§Ø±Ø³ÛŒ.md)

[Telegram äº¤æµç¾¤](https://t.me/+ft-zI76oovgwNmRh)

## ğŸ“– ç›®å½•

1.  [ç®€ä»‹ä¸è®¾è®¡å“²å­¦ (Introduction & Philosophy)](#ç®€ä»‹ä¸è®¾è®¡å“²å­¦-introduction--philosophy)
2.  [æ ¸å¿ƒæ¦‚å¿µ: é‚®å·®çš„æ¯”å–» (The Mailman Analogy)](#æ ¸å¿ƒæ¦‚å¿µ-é‚®å·®çš„æ¯”å–»-the-mailman-analogy)
3.  [æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘ (System Architecture)](#æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘-system-architecture)
4.  [é…ç½®ç™¾ç§‘å…¨ä¹¦ (Configuration Encyclopedia)](#é…ç½®ç™¾ç§‘å…¨ä¹¦-configuration-encyclopedia)
    *   [1. èº«ä»½ä¸è®¤è¯ (Identity)](#1-èº«ä»½ä¸è®¤è¯-identity)
    *   [2. ç½‘ç»œä¸ä¸­ç»§ (Network & Relay)](#2-ç½‘ç»œä¸ä¸­ç»§-network--relay)
    *   [3. åè®®å¼€å…³ (Protocols)](#3-åè®®å¼€å…³-protocols)
    *   [4. é€»è¾‘æ§åˆ¶ (Logic Control)](#4-é€»è¾‘æ§åˆ¶-logic-control)
    *   [5. ä¼˜é€‰ä¸é«˜çº§ (Preferred & Advanced)](#5-ä¼˜é€‰ä¸é«˜çº§-preferred--advanced)
5.  [åè®®æ·±åº¦è§£æä¸å¯¹æ¯” (Protocol Deep Dive)](#åè®®æ·±åº¦è§£æä¸å¯¹æ¯”-protocol-deep-dive)
6.  [ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ (Scenarios)](#ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ-scenarios)
7.  [ä»é›¶å¼€å§‹å®‰è£… (Zero to Hero)](#ä»é›¶å¼€å§‹å®‰è£…-zero-to-hero)
8.  [å®¢æˆ·ç«¯é…ç½®æŒ‡å— (Client Configuration)](#å®¢æˆ·ç«¯é…ç½®æŒ‡å—-client-configuration)
9.  [æ•…éšœæ’é™¤ä¸æ—¥å¿— (Troubleshooting & Logs)](#æ•…éšœæ’é™¤ä¸æ—¥å¿—-troubleshooting--logs)
10. [API ç®¡ç†æŒ‡å— (API Management)](#api-ç®¡ç†æŒ‡å—-api-management)
11. [Star History](#star-history)

---

## ç®€ä»‹ä¸è®¾è®¡å“²å­¦ (Introduction & Philosophy)

CFnew æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Cloudflare Workers ä¸Šçš„å…¨èƒ½ä»£ç†è„šæœ¬ï¼Œä¸“ä¸º**æŠ—å°é”**ã€**é«˜æ€§èƒ½**å’Œ**æ˜“ç®¡ç†**è€Œè®¾è®¡ã€‚

*   **æ— æœåŠ¡å™¨ (Serverless)**: æ— éœ€è´­ä¹° VPSï¼Œåˆ©ç”¨ Cloudflare éå¸ƒå…¨çƒçš„ 300+ æ•°æ®ä¸­å¿ƒã€‚
*   **æ— ä»£ç ç®¡ç† (No-Code Management)**: ä¸€æ—¦éƒ¨ç½²ï¼Œæ‰€æœ‰é…ç½®ï¼ˆUUIDã€IPã€åè®®å¼€å…³ï¼‰å‡é€šè¿‡ KV å­˜å‚¨åœ¨ç½‘é¡µç«¯å›¾å½¢åŒ–ç®¡ç†ã€‚æ‚¨æ°¸è¿œä¸éœ€è¦å†æ¬¡ç¼–è¾‘ä»£ç æ–‡ä»¶ã€‚
*   **å¤šæ€ä¼ªè£… (Polymorphic Camouflage)**: æ—¢æ˜¯ VLESS èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯ Trojan èŠ‚ç‚¹ï¼Œè¿˜èƒ½é€šè¿‡è‡ªå®šä¹‰è·¯å¾„ä¼ªè£…æˆæ™®é€šçš„å¾®è½¯æˆ–è°·æ­Œé¡µé¢ã€‚
*   **æ™ºèƒ½è·¯ç”± (Intelligent Routing)**: å†…ç½®åœ°ç†ä½ç½®åŒ¹é…ï¼Œè‡ªåŠ¨è®© Worker è¿æ¥åˆ°ç¦»æ‚¨ç‰©ç†ä½ç½®æœ€è¿‘çš„æ•°æ®ä¸­å¿ƒã€‚

---

## æ ¸å¿ƒæ¦‚å¿µ: é‚®å·®çš„æ¯”å–» (The Mailman Analogy)

ä¸ºäº†è®©å¤§å®¶å½»åº•ç†è§£ä»£ç†æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬å°†å…¶æ‹†è§£ä¸ºä¸€ä¸ªè¯¦ç»†çš„**é‚®æ”¿ç³»ç»Ÿ**æ¯”å–»ã€‚

### è§’è‰²åˆ†é…
*   **æ‚¨ (Client)**: å¯„ä¿¡äººï¼ˆè¯•å›¾è®¿é—®è¢«å¢™ç½‘ç«™çš„ç”¨æˆ·ï¼‰ã€‚
*   **ç›®æ ‡ç½‘ç«™ (Google/YouTube)**: æ”¶ä¿¡äººã€‚
*   **é˜²ç«å¢™ (Firewall)**: ä¸¥æ ¼çš„é‚®å±€æ£€æŸ¥å‘˜ï¼ŒæŒæœ‰â€œé»‘åå•â€ï¼Œç¦æ­¢ç›´æ¥å¯„ä¿¡ç»™ Googleã€‚
*   **Cloudflare Worker**: ä½äºâ€œè‡ªç”±è´¸æ˜“åŒºâ€çš„ä¸­è½¬ç«™å·¥ä½œäººå‘˜ï¼ˆåˆæ³•çš„ä¸­è½¬ç«™ï¼‰ã€‚
*   **UUID**: æ‚¨çš„ä¸“å±å°ç« /é€šè¡Œè¯ï¼ˆé˜²æ­¢å¤–äººæ»¥ç”¨æ‚¨çš„ä¸­è½¬æœåŠ¡ï¼‰ã€‚
*   **ProxyIP**: ä½åœ¨ç›®æ ‡ç½‘ç«™éš”å£çš„â€œå¥½é‚»å±…â€ï¼ˆç§˜å¯†å¿«é€’å‘˜ï¼‰ã€‚

### æµç¨‹æ‹†è§£

#### 1. å°è£… (The Envelope)
æ‚¨æƒ³ç»™ Google å†™ä¿¡ï¼Œä½†ä¸èƒ½ç›´æ¥å†™â€œTo: Googleâ€ã€‚
*   **åŠ¨ä½œ**: æ‚¨æŠŠå†™ç»™ Google çš„ä¿¡ï¼ˆåŠ å¯†æ•°æ®ï¼‰ï¼Œè£…è¿›ä¸€ä¸ªå†™ç€ **"To: Cloudflare"** çš„æ™®é€šå•†ä¸šä¿¡å°é‡Œã€‚
*   **è®¤è¯**: æ‚¨åœ¨ä¿¡å°å£ç›–ä¸Šæ‚¨çš„ **UUID å°ç« **ã€‚åªæœ‰æ‹¥æœ‰æ ¸å¯¹åå†Œçš„ Worker æ‰èƒ½ç¡®è®¤è¿™æ˜¯æ‚¨çš„ä¿¡ã€‚
*   **åè®®**: è¿™å°±æ˜¯ **VLESS/Trojan** åè®®çš„ä½œç”¨â€”â€”ä¼ªè£…å’Œå°è£…ã€‚

#### 2. æŠ•é€’ (Transmission)
*   **åŠ¨ä½œ**: æ‚¨æŠŠä¿¡æŠ•è¿›æœ¬åœ°é‚®ç­’ã€‚
*   **æ£€æŸ¥**: é‚®å±€æ£€æŸ¥å‘˜ï¼ˆé˜²ç«å¢™ï¼‰æ‹¿èµ·ä¿¡å°ï¼Œçœ‹åˆ°æ”¶ä»¶äººæ˜¯ "Cloudflareå…¬å¸"ï¼ˆä¸€å®¶åˆæ³•çš„è·¨å›½ä¼ä¸šï¼‰ï¼Œå¹¶ä¸”ä¿¡å°çœ‹èµ·æ¥å¾ˆæ­£è§„ï¼ˆHTTPS/TLS åŠ å¯†ï¼‰ï¼Œäºæ˜¯æ”¾è¡Œã€‚
*   **ç»“æœ**: æ‚¨çš„ä¿¡æˆåŠŸé£è¶Šäº†å°é”çº¿ï¼Œåˆ°è¾¾äº† Cloudflare çš„å…¨çƒä»“åº“ã€‚

#### 3. åˆ†æ‹£ (Sorting - The Worker)
*   **æ¥æ”¶**: Cloudflare çš„ Worker æ”¶åˆ°ä¿¡ã€‚
*   **éªŒè¯**: Worker é¦–å…ˆæ£€æŸ¥ **UUID å°ç« **ã€‚
    *   *å°ç« é”™è¯¯?* -> ç›´æ¥ä¸¢å¼ƒæˆ–é€€å›ï¼ˆæ‹’ç»è¿æ¥ï¼‰ã€‚
    *   *å°ç« æ­£ç¡®?* -> æ‰“å¼€å¤–å±‚ä¿¡å°ã€‚
*   **è¯»å–**: Worker æ‹¿å‡ºé‡Œé¢çš„ä¿¡ï¼Œçœ‹åˆ°çœŸæ­£çš„æ”¶ä»¶äººæ˜¯ **"Google"**ã€‚

#### 4. æ´¾é€ (Delivery Methods)
è¿™æ—¶å€™ï¼ŒWorker æœ‰ä¸¤ç§æ´¾é€æ–¹å¼ï¼ˆå–å†³äºæ‚¨çš„é…ç½®ï¼‰ï¼š

*   **ğŸ…°ï¸ äº²è‡ªé€è¾¾ (Native Mode)**
    *   Worker ç›´æ¥èµ°å‡ºä»“åº“ï¼Œæ•²å¼€ Google çš„é—¨ï¼ŒæŠŠä¿¡äº¤ç»™å®ƒã€‚
    *   *ç‰¹ç‚¹*: é€Ÿåº¦å¿«ï¼Œä½† Google çœ‹åˆ°çš„æ˜¯ Worker çš„è„¸ï¼ˆCloudflare IPï¼‰ã€‚æŸäº›ç½‘ç«™ï¼ˆå¦‚ Netflixï¼‰å¯èƒ½ä¼šå› ä¸ºâ€œä¸å–œæ¬¢ Cloudflare å‘˜å·¥â€è€Œæ‹’ç»æœåŠ¡ã€‚

*   **ğŸ…±ï¸ ç§˜å¯†å¿«é€’ (ProxyIP Mode)**
    *   Worker è§‰å¾—ç›´æ¥å»ä¸å®‰å…¨ï¼Œæˆ–è€… Google æ‹’æ”¶ Cloudflare çš„ä¿¡ã€‚
    *   Worker æŠŠä¿¡äº¤ç»™äº†ä¸€ä½**ç§˜å¯†å¿«é€’å‘˜ (ProxyIP)**ã€‚
    *   å¿«é€’å‘˜æ‹¿ç€ä¿¡å»é€ç»™ Googleã€‚
    *   *ç‰¹ç‚¹*: Google çœ‹åˆ°çš„æ˜¯å¿«é€’å‘˜çš„è„¸ï¼ˆä½å®… IP / å½“åœ° IPï¼‰ï¼Œéå¸¸é€‚åˆè§£é”æµåª’ä½“ã€‚

#### 5. å›ä¿¡ (The Return Journey)
*   Google å†™å¥½å›ä¿¡ï¼Œäº¤ç»™å¿«é€’å‘˜æˆ– Workerã€‚
*   Worker æŠŠå›ä¿¡è£…è¿›ä¸€ä¸ª **"From: Cloudflare"** çš„ä¿¡å°ã€‚
*   ä¿¡å°å›åˆ°æ‚¨çš„æ‰‹ä¸­ã€‚é‚®å±€æ£€æŸ¥å‘˜åªçœ‹åˆ°æ‚¨æ”¶åˆ°äº†ä¸€å°æ¥è‡ª Cloudflare çš„å•†åŠ¡ä¿¡ä»¶ï¼Œå®Œå…¨ä¸çŸ¥é“é‡Œé¢æ˜¯ Google çš„å›å¤ã€‚

---

## æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘ (System Architecture)

### 1. åŸç”Ÿæ¨¡å¼ (Native Mode)
*é€‚ç”¨: VLESS, Trojan, VLESS gRPC, xhttp*
Worker ç›´æ¥å¤„ç†æµé‡ã€‚å»¶è¿Ÿæœ€ä½ã€‚

```mermaid
graph LR
    Client[å®¢æˆ·ç«¯] -->|TLSåŠ å¯†| CF[Cloudflareè¾¹ç¼˜]
    CF -->|è§¦å‘| Worker[CFnewè„šæœ¬]
    Worker -->|è§£å¯†| Target[ç›®æ ‡ç½‘ç«™]
    Target -->|å“åº”| Worker
    Worker -->|åŠ å¯†| Client
```

### 2. ProxyIP æ¨¡å¼ (Relay Mode)
*é€‚ç”¨: VLESS, Trojan (é…åˆ p å˜é‡)*
Worker é€šè¿‡ TCP å°†æµé‡ä¸­ç»§ç»™ç¬¬ä¸‰æ–¹ IPã€‚

```mermaid
graph LR
    Client --> CF
    CF --> Worker
    Worker -->|TCPè¿æ¥| ProxyIP[ProxyIP/VPS]
    ProxyIP -->|è¯·æ±‚| Target
    Target --> ProxyIP
    ProxyIP --> Worker
```

### 3. ECH æ¡æ‰‹æµç¨‹ (ECH Flow)
*é€‚ç”¨: å¼€å¯ ECH åŠŸèƒ½å*
SNI è¢«åŠ å¯†ï¼Œé˜²ç«å¢™æ— æ³•çœ‹åˆ°ç›®æ ‡åŸŸåã€‚

```mermaid
graph TD
    Client -->|1. è·å–ECHé…ç½®| DoH[DoHæœåŠ¡å™¨]
    DoH -->|2. è¿”å›å…¬é’¥| Client
    Client -->|3. ClientHello (åŠ å¯†SNI)| CF
    CF -->|4. è§£å¯†SNI| Worker
    Worker --> Target
```

---

## é…ç½®ç™¾ç§‘å…¨ä¹¦ (Configuration Encyclopedia)

è¿™é‡ŒåŒ…å«ä»£ç ä¸­æ‰€æœ‰å¯ç”¨çš„é…ç½®å˜é‡ã€‚
**ä¼˜å…ˆçº§**: KV (å›¾å½¢ç•Œé¢) > ç¯å¢ƒå˜é‡ (Settings)ã€‚

### 1. èº«ä»½ä¸è®¤è¯ (Identity)

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | è¯¦ç»†è¯´æ˜ | ä¸ºä»€ä¹ˆä½¿ç”¨? |
| :--- | :--- | :--- | :--- | :--- |
| **`u`** | String | (å¿…éœ€) | **UUID**ã€‚ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿æ¥æ—¶çš„å¯†ç ã€‚å¿…é¡»æ˜¯æ ‡å‡†çš„ UUID æ ¼å¼ã€‚ | **å®‰å…¨**ã€‚é˜²æ­¢æœªæˆæƒç”¨æˆ·ä½¿ç”¨æ‚¨çš„ä»£ç†æ¶ˆè€—æµé‡ã€‚ |
| **`tp`** | String | `u` | **Trojan Password**ã€‚Trojan åè®®ä¸“ç”¨çš„å¯†ç ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨ä½¿ç”¨ UUIDã€‚å®¢æˆ·ç«¯ä¼šå¯¹å¯†ç è¿›è¡Œ SHA224 å“ˆå¸Œã€‚ | **å…¼å®¹æ€§**ã€‚æŸäº›æ—§ç‰ˆ Trojan å®¢æˆ·ç«¯å¯èƒ½ä¸æ”¯æŒ UUID æ ¼å¼çš„å¯†ç ã€‚ |

### 2. ç½‘ç»œä¸ä¸­ç»§ (Network & Relay)

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | è¯¦ç»†è¯´æ˜ | ä¸ºä»€ä¹ˆä½¿ç”¨? |
| :--- | :--- | :--- | :--- | :--- |
| **`p`** | String | (ç©º) | **ProxyIP**ã€‚æµé‡è½¬å‘ç›®æ ‡ (IP:Port)ã€‚Worker æ”¶åˆ°è¯·æ±‚åï¼Œä¸ç›´æ¥è®¿é—®ç›®æ ‡ï¼Œè€Œæ˜¯è½¬å‘ç»™è¿™ä¸ª IPã€‚ | **è§£å°/éšè—**ã€‚è§£å†³ CF IP è¢«å¢™ã€è¢«ç½‘ç«™å±è”½ (å¦‚ Netflix) é—®é¢˜ã€‚ |
| **`s`** | String | (ç©º) | **SOCKS5**ã€‚æ ¼å¼ `user:pass@host:port`ã€‚ä¼˜å…ˆçº§é«˜äº `p`ã€‚æ”¯æŒåŸºäºç”¨æˆ·åå¯†ç çš„è®¤è¯ã€‚ | **ç‰¹å®šå‡ºå£**ã€‚å¦‚æœæ‚¨æœ‰ç‰¹å®šå›½å®¶çš„ SOCKS5 ä»£ç†ï¼Œæƒ³è®©æµé‡ä»é‚£é‡Œå‡ºæ¥ã€‚ |
| **`d`** | String | (ç©º) | **è‡ªå®šä¹‰è·¯å¾„**ã€‚è®¾ç½®åï¼Œå¿…é¡»é€šè¿‡ `domain.com/è·¯å¾„` è®¿é—®é¢æ¿ã€‚UUID è·¯å¾„å°†å¤±æ•ˆã€‚ | **é˜²æ¢æµ‹**ã€‚è®© Worker çœ‹èµ·æ¥åƒä¸ªæ™®é€šç½‘ç«™ï¼Œåªæœ‰çŸ¥é“è·¯å¾„çš„äººæ‰èƒ½çœ‹åˆ°é¢æ¿ã€‚ |
| **`wk`** | String | (è‡ªåŠ¨) | **Worker Region**ã€‚å¼ºåˆ¶æŒ‡å®š Worker åœ°åŒº (å¦‚ `SG`, `US`, `JP`)ã€‚ | **å°±è¿‘æ¥å…¥**ã€‚å¼ºåˆ¶ Worker ä½¿ç”¨æŒ‡å®šåœ°åŒºçš„ä¼˜é€‰ IPï¼Œé™ä½å»¶è¿Ÿã€‚ |

### 3. åè®®å¼€å…³ (Protocols)

è®¾ç½®ä¸º `yes` å¼€å¯ï¼Œ`no` å…³é—­ã€‚

| å˜é‡å | åè®® | ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **`ev`** | VLESS | Native | æœ€è½»é‡ï¼Œæ— çŠ¶æ€ï¼Œæ€§èƒ½æœ€ä½³ã€‚ | æ—¥å¸¸æµè§ˆï¼Œçœ‹è§†é¢‘ (4K)ã€‚ |
| **`et`** | Trojan | Native | æ¨¡æ‹Ÿ HTTPS æµé‡ï¼ŒæŠ—å¹²æ‰°å¼ºã€‚ | ç½‘ç»œå®¡æŸ¥ä¸¥æ ¼çš„ç¯å¢ƒã€‚ |
| **`ex`** | xhttp | Native | åŸºäº HTTP POST çš„ä¼ªè£…åè®®ã€‚ | éœ€è¦æè‡´ä¼ªè£…ï¼Œé€šè¿‡ gRPC ä¼ è¾“ã€‚ |
| **`eg`** | VLESS gRPC | Native | ä½¿ç”¨ gRPC ä¼ è¾“ã€‚ | å¯¹é•¿è¿æ¥æ”¯æŒè¾ƒå¥½çš„ç½‘ç»œã€‚ |
| **`evm`** | VMess | Relay | ä»…ç”Ÿæˆé“¾æ¥ã€‚éœ€è‡ªå»ºåç«¯ã€‚ | æ‰‹é‡Œæœ‰é—²ç½® VPSï¼Œæƒ³é€šè¿‡ CF ä¸­è½¬ã€‚ |
| **`ess`** | Shadowsocks | Relay | ä»…ç”Ÿæˆé“¾æ¥ã€‚éœ€è‡ªå»ºåç«¯ã€‚ | è€æ—§è®¾å¤‡ï¼Œæˆ–è€…æ˜¯ SS ä¸“ç”¨çš„åç«¯ã€‚ |
| **`etu`** | TUIC | Direct | ä»…ç”Ÿæˆé“¾æ¥ã€‚UDP åè®®ã€‚ | æ¸¸æˆåŠ é€Ÿï¼Œä½å»¶è¿Ÿéœ€æ±‚ (éœ€åç«¯)ã€‚ |
| **`ehy`** | Hysteria 2 | Direct | ä»…ç”Ÿæˆé“¾æ¥ã€‚UDP åè®®ã€‚ | æ¶åŠ£ç½‘ç»œç¯å¢ƒä¸‹çš„æš´åŠ›åŠ é€Ÿ (éœ€åç«¯)ã€‚ |
| **`ech`** | ECH | - | å¯ç”¨ Encrypted Client Helloã€‚ | é˜²æ­¢ SNI é˜»æ–­ï¼Œæœ€é«˜å®‰å…¨çº§åˆ«ã€‚ |

### 4. é€»è¾‘æ§åˆ¶ (Logic Control)

| å˜é‡å | åŠŸèƒ½ | é»˜è®¤ | è¯¦ç»†è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **`rm`** | Region Match | `yes` | **åœ°åŒºåŒ¹é…**ã€‚æ˜¯å¦æ ¹æ®è®¿é—®è€… IP è‡ªåŠ¨åŒ¹é…æœ€è¿‘çš„ Worker èŠ‚ç‚¹ã€‚è®¾ä¸º `no` åˆ™éšæœºåˆ†é…ã€‚ |
| **`qj`** | Downgrade | `yes` | **é™çº§æ§åˆ¶**ã€‚è®¾ä¸º `no` å¼€å¯è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚é€»è¾‘ï¼šCFç›´è¿å¤±è´¥ -> å°è¯• SOCKS5 -> å°è¯• ProxyIPã€‚ |
| **`dkby`** | Port Filter | `no` | **ç«¯å£è¿‡æ»¤**ã€‚è®¾ä¸º `yes` åˆ™åªç”Ÿæˆ TLS (443/2053ç­‰) èŠ‚ç‚¹ï¼Œå±è”½é TLS (80/8080ç­‰)ã€‚ECH å¼€å¯æ—¶å¼ºåˆ¶ä¸º yesã€‚ |
| **`yxby`** | Prefer Filter | `no` | **ä¼˜é€‰è¿‡æ»¤**ã€‚è®¾ä¸º `yes` åˆ™**ç¦ç”¨**æ‰€æœ‰ä¼˜é€‰ IPï¼Œåªä¿ç•™åŸç”Ÿ Worker åœ°å€ã€‚ |
| **`ae`** | API Enable | `no` | **API å¼€å…³**ã€‚è®¾ä¸º `yes` å…è®¸é€šè¿‡ REST API ä¿®æ”¹é…ç½®/IPã€‚å»ºè®®ä»…åœ¨éœ€è¦æ—¶å¼€å¯ã€‚ |
| **`scu`** | SubConverter | (å†…ç½®) | **è®¢é˜…è½¬æ¢åç«¯**ã€‚ç”¨äºå°† VLESS é“¾æ¥è½¬æ¢ä¸º Clash/Surge æ ¼å¼ã€‚é»˜è®¤ä½¿ç”¨ `url.v1.mk`ã€‚ |
| **`homepage`**| Camouflage | (ç©º) | **ä¼ªè£…é¦–é¡µ**ã€‚è®¿é—®æ ¹è·¯å¾„ `/` æ—¶ï¼ŒWorker ä¼šè·å–æ­¤ URL çš„å†…å®¹å¹¶è¿”å›ã€‚æ¨¡æ‹ŸçœŸå®ç½‘ç«™ã€‚ |

### 5. ä¼˜é€‰ä¸é«˜çº§ (Preferred & Advanced)

è¿™äº›å˜é‡æ§åˆ¶å¦‚ä½•è·å–å’Œè¿‡æ»¤ä¼˜é€‰ IPã€‚

| å˜é‡å | è¯´æ˜ | é»˜è®¤ | è¿‡æ»¤é€»è¾‘ |
| :--- | :--- | :--- | :--- |
| **`yx`** | **è‡ªå®šä¹‰ä¼˜é€‰ IP åˆ—è¡¨**ã€‚KV ä¸­ç›´æ¥å­˜å‚¨ã€‚æ ¼å¼: `IP:Port#å¤‡æ³¨`ã€‚ | - | æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸åšè¿è¥å•†è¿‡æ»¤ã€‚ |
| **`yxURL`** | **ä¼˜é€‰ IP è¿œç¨‹æº**ã€‚è¦†ç›–å†…ç½®æºã€‚æŒ‡å‘ä¸€ä¸ª TXT æ–‡ä»¶ã€‚ | (å†…ç½®) | ä» URL ä¸‹è½½ IP åˆ—è¡¨ã€‚ |
| **`ipv4`** | æ˜¯å¦è·å– IPv4 ä¼˜é€‰ IPã€‚ | `yes` | è®¾ä¸º `no` åˆ™ä¸¢å¼ƒæºä¸­çš„ IPv4 åœ°å€ã€‚ |
| **`ipv6`** | æ˜¯å¦è·å– IPv6 ä¼˜é€‰ IPã€‚ | `yes` | è®¾ä¸º `no` åˆ™ä¸¢å¼ƒæºä¸­çš„ IPv6 åœ°å€ã€‚ |
| **`ispMobile`**| æ˜¯å¦åŒ…å«**ä¸­å›½ç§»åŠ¨**ä¼˜é€‰ IPã€‚ | `yes` | æ ¹æ®å¤‡æ³¨å…³é”®è¯è¿‡æ»¤ã€‚ |
| **`ispTelecom`**| æ˜¯å¦åŒ…å«**ä¸­å›½ç”µä¿¡**ä¼˜é€‰ IPã€‚ | `yes` | æ ¹æ®å¤‡æ³¨å…³é”®è¯è¿‡æ»¤ã€‚ |
| **`ispUnicom`** | æ˜¯å¦åŒ…å«**ä¸­å›½è”é€š**ä¼˜é€‰ IPã€‚ | `yes` | æ ¹æ®å¤‡æ³¨å…³é”®è¯è¿‡æ»¤ã€‚ |
| **`customDNS`** | ECH æŸ¥è¯¢ç”¨çš„ DoH åœ°å€ (HTTPS)ã€‚ | (å†…ç½®) | ç”¨äºè§£æ ECH é…ç½®ã€‚ä¸æ”¯æŒ UDP 53ã€‚ |
| **`customECHDomain`**| ECH ç›®æ ‡é…ç½®åŸŸåã€‚ | (å†…ç½®) | ä»è¯¥åŸŸåè·å– ECHConfigã€‚ |

---

## åè®®æ·±åº¦è§£æä¸å¯¹æ¯” (Protocol Deep Dive)

| ç‰¹æ€§ | VLESS (Native) | Trojan (Native) | VMess (Relay) | TUIC/Hysteria (Direct) |
| :--- | :--- | :--- | :--- | :--- |
| **ç±»å‹** | æ— çŠ¶æ€è½»é‡åè®® | æ¨¡æ‹Ÿ HTTPS | ç»å…¸åè®® | UDP é«˜é€Ÿåè®® |
| **Worker è§’è‰²** | ä»£ç†æœåŠ¡å™¨ | ä»£ç†æœåŠ¡å™¨ | WebSocket ä¸­ç»§ | é…ç½®ç”Ÿæˆå™¨ (ä¸ç»æ‰‹æµé‡) |
| **åç«¯éœ€æ±‚** | æ—  (Serverless) | æ—  (Serverless) | éœ€è¦ VPS | éœ€è¦ VPS |
| **æŠ—å°é”** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ (æ‹¥å¡æ§åˆ¶) |
| **å»¶è¿Ÿ** | ğŸŸ¢ æä½ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ (å¤šä¸€è·³) | ğŸŸ¢ æä½ (UDP) |
| **èµ„æºæ¶ˆè€—** | ğŸŸ¢ æä½ | ğŸŸ¡ ä½ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ |
| **é€‚ç”¨åœºæ™¯** | 4K è§†é¢‘, æµè§ˆ | æ•æ„Ÿæ—¶æœŸ, åŠå…¬ | æ—§è®¾å¤‡å…¼å®¹ | æ¸¸æˆ, æ¶åŠ£ç½‘ç»œç¯å¢ƒ |

### ECH æŠ€æœ¯è¯¦è§£
**Encrypted Client Hello (ECH)** æ˜¯ä¸€é¡¹æ—¨åœ¨åŠ å¯† TLS æ¡æ‰‹é˜¶æ®µ (Client Hello) çš„æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯åŠ å¯† **SNI (Server Name Indication)**ã€‚
1.  **é—®é¢˜**: ä¼ ç»Ÿ TLS æ¡æ‰‹ä¸­ï¼ŒSNI æ˜¯æ˜æ–‡çš„ã€‚é˜²ç«å¢™å¯ä»¥çœ‹åˆ°æ‚¨è®¿é—®äº† `google.com` å¹¶é˜»æ–­è¿æ¥ã€‚
2.  **è§£å†³**: ECH å°† SNI åŠ å¯†ã€‚é˜²ç«å¢™åªèƒ½çœ‹åˆ°æ‚¨è¿æ¥åˆ°äº† Cloudflareï¼Œä½†ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªç½‘ç«™ã€‚
3.  **Worker å®ç°**: Worker å……å½“ ECH é…ç½®çš„â€œåˆ†å‘è€…â€ï¼Œé€šè¿‡ DoH (`customDNS`) è·å–é…ç½®å¹¶æ³¨å…¥è®¢é˜…ã€‚

---

## ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ (Scenarios)

### åœºæ™¯ 1: ISP ä¸“å±ä¼˜åŒ– (ISP Optimization)
**ç›®æ ‡**: æ‚¨æ˜¯ä¸­å›½ç§»åŠ¨å®½å¸¦ç”¨æˆ·ï¼Œæƒ³è¦æœ€å¿«çš„è¿æ¥ã€‚
1.  è¿›å…¥é…ç½®é¢æ¿ã€‚
2.  è®¾ç½® `ispMobile = yes`ã€‚
3.  è®¾ç½® `ispTelecom = no` å’Œ `ispUnicom = no`ã€‚
4.  è®¾ç½® `epi = yes` (å¯ç”¨åŠ¨æ€ä¼˜é€‰)ã€‚
5.  **ç»“æœ**: è®¢é˜…é“¾æ¥ä¸­å°†åªåŒ…å«å¯¹ä¸­å›½ç§»åŠ¨çº¿è·¯ä¼˜åŒ–è¿‡çš„ Cloudflare IPï¼Œå‡å°‘ä¸¢åŒ…ã€‚

### åœºæ™¯ 2: æ¸¸æˆä½å»¶è¿Ÿæ¨¡å¼ (Gaming Mode)
**ç›®æ ‡**: ç©å¤–æœæ¸¸æˆï¼Œéœ€è¦ UDP å’Œä½å»¶è¿Ÿã€‚
1.  æ‚¨éœ€è¦ä¸€å°è‡ªå»ºçš„ Hysteria 2 æœåŠ¡å™¨ (VPS)ã€‚
2.  åœ¨ Worker ä¸­è®¾ç½® `ehy = yes`ã€‚
3.  Worker ä¼šç”ŸæˆæŒ‡å‘æ‚¨ VPS çš„ Hysteria 2 é“¾æ¥ã€‚
4.  å®¢æˆ·ç«¯ä½¿ç”¨è¯¥é“¾æ¥è¿æ¥ã€‚ç”±äº Hysteria 2 åŸºäº UDPï¼Œæ¸¸æˆå»¶è¿Ÿå°†æ˜¾è‘—ä½äº TCP åè®®ã€‚

### åœºæ™¯ 3: æè‡´éšè”½ä¸å®‰å…¨ (Paranoid Mode)
**ç›®æ ‡**: é˜²æ­¢æ¢æµ‹ï¼Œé˜²æ­¢ SNI é˜»æ–­ã€‚
1.  è®¾ç½® `d = /my-super-secret-path`ã€‚
2.  è®¾ç½® `ech = yes`ã€‚åŠ å¯† SNIã€‚
3.  è®¾ç½® `homepage = https://www.microsoft.com`ã€‚ç›´æ¥è®¿é—®æ ¹åŸŸåæ˜¾ç¤ºå¾®è½¯é¦–é¡µã€‚
4.  **ç»“æœ**: å³ä½¿é˜²ç«å¢™ä¸»åŠ¨æ¢æµ‹æ‚¨çš„åŸŸåï¼Œçœ‹åˆ°çš„ä¹Ÿåªæ˜¯å¾®è½¯é¦–é¡µï¼›æµé‡åˆ†æä¹Ÿæ— æ³•å¾—çŸ¥ç›®æ ‡ç½‘ç«™ã€‚

---

## ä»é›¶å¼€å§‹å®‰è£… (Zero to Hero)

### 1. éƒ¨ç½² Worker
1.  ç™»å½• [Cloudflare Dash](https://dash.cloudflare.com)ã€‚
2.  é€‰æ‹© **Workers & Pages** -> **Create Worker**ã€‚
3.  å‘½å (å¦‚ `cf-proxy`) -> **Deploy**ã€‚
4.  ç‚¹å‡» **Edit Code**ã€‚
5.  **å…³é”®æ­¥éª¤**: æ‰“å¼€æœ¬é¡¹ç›®çš„ `å°‘å¹´ä½ ç›¸ä¿¡å…‰å—` æ–‡ä»¶ï¼Œå…¨é€‰å¤åˆ¶ã€‚
6.  æ¸…ç©º Cloudflare ç¼–è¾‘å™¨ä¸­çš„ä»£ç ï¼Œç²˜è´´è¿›å»ã€‚
7.  **Save and deploy**ã€‚

### 2. é…ç½® KV (å¿…é¡»!)
æ²¡æœ‰ KVï¼Œå›¾å½¢é¢æ¿æ— æ³•ä¿å­˜é…ç½®ã€‚
1.  **Workers & Pages** -> **KV** -> **Create Namespace** -> å‘½åä¸º `CONFIG` -> **Add**ã€‚
2.  å›åˆ°æ‚¨çš„ Worker -> **Settings** -> **Variables** -> **KV Namespace Bindings**ã€‚
3.  **Add binding**:
    *   Variable name: `C` (å¿…é¡»æ˜¯å¤§å†™)ã€‚
    *   Namespace: é€‰æ‹© `CONFIG`ã€‚
4.  **Save and deploy**ã€‚

### 3. åˆå§‹åŒ–å˜é‡
1.  **Settings** -> **Variables** -> **Environment Variables**ã€‚
2.  **Add variable**:
    *   Variable name: `u`
    *   Value: `æ‚¨çš„UUID` (ä½¿ç”¨ `uuidgen` ç”Ÿæˆ)ã€‚
3.  **Save and deploy**ã€‚

### 4. éªŒè¯
è®¿é—® `https://æ‚¨çš„åŸŸå/æ‚¨çš„UUID`ã€‚å¦‚æœçœ‹åˆ°å¸¦æœ‰çŸ©é˜µé›¨ç‰¹æ•ˆçš„ç»ˆç«¯ç•Œé¢ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼

---

## å®¢æˆ·ç«¯é…ç½®æŒ‡å— (Client Configuration)

### Sing-box
*   **é…ç½®**: å»ºè®®ä½¿ç”¨ `vless` æˆ– `trojan` outboundã€‚
*   **ECH**: åœ¨ `tls` é…ç½®æ®µä¸­æ·»åŠ  `ech: { enabled: true }`ã€‚
*   **Multiplex**: å»ºè®®å¼€å¯ `multiplex: { enabled: true }` ä»¥æé«˜å¹¶å‘æ€§èƒ½ã€‚

### v2rayNG (Android)
*   **Sniffing**: å¿…é¡»å¼€å¯ (æµé‡å—…æ¢)ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®åˆ†æµå›½å†…å¤–æµé‡ã€‚
*   **Mux**: å»ºè®®å…³é—­ã€‚è™½ç„¶ç†è®ºä¸Šé™ä½å»¶è¿Ÿï¼Œä½†åœ¨ä¸ç¨³å®šç½‘ç»œä¸‹å®¹æ˜“å¯¼è‡´æ–­æµã€‚

### Surge (iOS/Mac)
*   **Skip-cert-verify**: å¦‚æœä½¿ç”¨ä¼˜é€‰ IPï¼Œå¿…é¡»è®¾ä¸º `true`ã€‚
*   **SNI**: ç¡®ä¿ SNI å­—æ®µå¡«å†™äº† Worker çš„åŸŸåã€‚

---

## æ•…éšœæ’é™¤ä¸æ—¥å¿— (Troubleshooting & Logs)

### å¦‚ä½•æŸ¥çœ‹ Worker æ—¥å¿—?
å¦‚æœè¿æ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯æœ€å¥½çš„åŠæ³•ï¼š
1.  Cloudflare Dash -> Worker -> **Logs**ã€‚
2.  ç‚¹å‡» **Begin log stream**ã€‚
3.  å°è¯•ç”¨å®¢æˆ·ç«¯è¿æ¥ä¸€æ¬¡ã€‚
4.  æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚
    *   `Status 200`: è¿æ¥æˆåŠŸã€‚
    *   `Status 403`: UUID é”™è¯¯æˆ–è·¯å¾„é”™è¯¯ã€‚
    *   `Status 502`: ProxyIP æ— æ³•è¿æ¥ã€‚

### å¸¸è§é”™è¯¯ä»£ç 

| ä»£ç  | é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
| :--- | :--- | :--- | :--- |
| **1101** | Worker Threw Exception | ä»£ç é”™è¯¯æˆ– KV æœªç»‘å®š | æ£€æŸ¥ KV æ˜¯å¦ç»‘å®šä¸ºå˜é‡ `C`ã€‚æ£€æŸ¥ä»£ç å®Œæ•´æ€§ã€‚ |
| **1033** | Argo Tunnel Error | Cloudflare å†…éƒ¨é”™è¯¯ | é€šå¸¸æ˜¯ä¸´æ—¶ç½‘ç»œæ³¢åŠ¨ï¼Œç¨åé‡è¯•ã€‚ |
| **1000** | DNS points to prohibited IP | DNS è§£æé”™è¯¯ | ProxyIP å¯èƒ½æŒ‡å‘äº† Cloudflare è‡ªå·±çš„ IP (å›ç¯)ã€‚æ›´æ¢ ProxyIPã€‚ |
| **1020** | Access Denied | é˜²ç«å¢™è§„åˆ™æ‹¦æˆª | æ£€æŸ¥ Cloudflare WAF è§„åˆ™ï¼Œæ˜¯å¦æ‹¦æˆªäº†ç‰¹å®šåœ°åŒº/IPã€‚ |
| **502** | Bad Gateway | ä¸Šæ¸¸æ— æ³•è¿æ¥ | **ProxyIP å¤±æ•ˆ**ã€‚Worker æ— æ³•è¿æ¥åˆ° `p` åœ°å€ã€‚æ›´æ¢ `p`ã€‚ |
| **522** | Connection Timed Out | è¿æ¥æºç«™è¶…æ—¶ | ç›®æ ‡ç½‘ç«™æˆ– ProxyIP è¢«å¢™ã€‚å°è¯•æ›´æ¢ç«¯å£æˆ– IPã€‚ |

---

## API ç®¡ç†æŒ‡å— (API Management)

**Endpoint**: `https://æ‚¨çš„åŸŸå/æ‚¨çš„è·¯å¾„/api/preferred-ips`
**é‰´æƒ**: ç›®å‰ä¾èµ–è·¯å¾„ä¸­çš„ UUID ä½œä¸ºéšå¼é‰´æƒã€‚

### 1. è·å–æ‰€æœ‰ IP (GET)
```bash
curl -X GET https://domain.com/uuid/api/preferred-ips
```

### 2. æ·»åŠ  IP (POST)
å‘ä¼˜é€‰åˆ—è¡¨ä¸­æ·»åŠ æ–°çš„ IPã€‚æ”¯æŒè‡ªåŠ¨å»é‡ã€‚
```bash
curl -X POST https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4", "port": 443, "name": "SG-Optimized"}'
```

### 3. åˆ é™¤ IP (DELETE)
åˆ é™¤æŒ‡å®šçš„ IPã€‚
```bash
curl -X DELETE https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4"}'
```

### 4. æ¸…ç©ºæ‰€æœ‰ (DELETE)
ä¸€é”®æ¸…ç©ºæ‰€æœ‰ä¼˜é€‰ IPï¼Œæ¢å¤é»˜è®¤çŠ¶æ€ã€‚
```bash
curl -X DELETE https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"all": true}'
```

---

## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=byJoey/cfnew&type=Timeline)](https://www.star-history.com/#byJoey/cfnew&Timeline&LogScale)
