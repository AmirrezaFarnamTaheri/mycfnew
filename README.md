# CFnew - ç»ˆç«¯ v2.9.3

**è¯­è¨€:** [ä¸­æ–‡](README.md) | [ÙØ§Ø±Ø³ÛŒ](ÙØ§Ø±Ø³ÛŒ.md)

[Telegram äº¤æµç¾¤](https://t.me/+ft-zI76oovgwNmRh)

## ğŸ“– ç›®å½•

1.  [ç®€ä»‹ä¸åŠŸèƒ½](#ç®€ä»‹ä¸åŠŸèƒ½)
2.  [æ ¸å¿ƒæ¦‚å¿µ: é‚®å·®çš„æ¯”å–» (The Mailman Analogy)](#æ ¸å¿ƒæ¦‚å¿µ-é‚®å·®çš„æ¯”å–»-the-mailman-analogy)
3.  [æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘ (System Architecture)](#æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘-system-architecture)
4.  [é…ç½®ç™¾ç§‘å…¨ä¹¦ (Configuration Encyclopedia)](#é…ç½®ç™¾ç§‘å…¨ä¹¦-configuration-encyclopedia)
    *   [1. èº«ä»½ä¸è®¤è¯ (Identity)](#1-èº«ä»½ä¸è®¤è¯-identity)
    *   [2. ç½‘ç»œä¸ä¸­ç»§ (Network & Relay)](#2-ç½‘ç»œä¸ä¸­ç»§-network--relay)
    *   [3. åè®®å¼€å…³ (Protocols)](#3-åè®®å¼€å…³-protocols)
    *   [4. é€»è¾‘æ§åˆ¶ (Logic Control)](#4-é€»è¾‘æ§åˆ¶-logic-control)
    *   [5. ä¼˜é€‰ä¸é«˜çº§ (Preferred & Advanced)](#5-ä¼˜é€‰ä¸é«˜çº§-preferred--advanced)
5.  [åè®®æ·±åº¦è§£æ (Protocol Deep Dive)](#åè®®æ·±åº¦è§£æ-protocol-deep-dive)
    *   [Native vs Link-Only](#native-vs-link-only)
    *   [ECH æŠ€æœ¯è¯¦è§£](#ech-æŠ€æœ¯è¯¦è§£)
6.  [ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ (Scenarios)](#ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ-scenarios)
7.  [ä»é›¶å¼€å§‹å®‰è£… (Zero to Hero)](#ä»é›¶å¼€å§‹å®‰è£…-zero-to-hero)
8.  [å®¢æˆ·ç«¯é…ç½®æŒ‡å—](#å®¢æˆ·ç«¯é…ç½®æŒ‡å—)
9.  [æ•…éšœæ’é™¤ (Troubleshooting)](#æ•…éšœæ’é™¤-troubleshooting)
10. [API ç®¡ç†](#api-ç®¡ç†)
11. [Star History](#star-history)

---

## ç®€ä»‹ä¸åŠŸèƒ½

CFnew æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Cloudflare Workers ä¸Šçš„å…¨èƒ½ä»£ç†è„šæœ¬ã€‚å®ƒåˆ©ç”¨ Cloudflare çš„å…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œä¸ºæ‚¨æä¾›å¿«é€Ÿã€å®‰å…¨ã€æŠ—å°é”çš„ç½‘ç»œè¿æ¥ã€‚

*   **å¤šåè®®å¹¶å‘**: åŸç”Ÿæ”¯æŒ VLESS, Trojan, VLESS gRPC, xhttpï¼Œå¹¶æ”¯æŒç”Ÿæˆ VMess, Shadowsocks, TUIC, Hysteria 2 è®¢é˜…é“¾æ¥ã€‚
*   **é«˜åº¦éšè”½**: æ”¯æŒè‡ªå®šä¹‰è·¯å¾„ (Hidden Path) å’Œä¼ªè£…é¦–é¡µï¼Œå®Œç¾æ¨¡æ‹Ÿæ­£å¸¸ç½‘ç«™ã€‚
*   **å›¾å½¢åŒ–ç®¡ç†**: å†…ç½® Web é¢æ¿ï¼Œé€šè¿‡ KV å­˜å‚¨é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç å³å¯å®æ—¶è°ƒæ•´ã€‚
*   **æ™ºèƒ½æµæ§**: é›†æˆ ProxyIP ä¸­ç»§ã€ä¼˜é€‰ IP ç®¡ç†ã€DoH ä»£ç†ã€å»¶è¿Ÿæµ‹è¯•ç­‰é«˜çº§åŠŸèƒ½ã€‚
*   **è‡ªåŠ¨åŒ–**: æ”¯æŒ API è°ƒç”¨ï¼Œæ–¹ä¾¿ç¼–å†™è„šæœ¬è‡ªåŠ¨æ›´æ–°ä¼˜é€‰ IPã€‚

---

## æ ¸å¿ƒæ¦‚å¿µ: é‚®å·®çš„æ¯”å–» (The Mailman Analogy)

ä¸ºäº†è®©å¤§å®¶å½»åº•ç†è§£ä»£ç†æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬å°†å…¶æ‹†è§£ä¸ºä¸€ä¸ªè¯¦ç»†çš„**é‚®æ”¿ç³»ç»Ÿ**æ¯”å–»ã€‚

### è§’è‰²åˆ†é…
*   **æ‚¨ (Client)**: å¯„ä¿¡äººã€‚
*   **ç›®æ ‡ç½‘ç«™ (Google/YouTube)**: æ”¶ä¿¡äººã€‚
*   **é˜²ç«å¢™ (Firewall)**: ä¸¥æ ¼çš„é‚®å±€æ£€æŸ¥å‘˜ï¼Œç¦æ­¢å¯„ä¿¡ç»™â€œé»‘åå•â€ä¸Šçš„æ”¶ä¿¡äººã€‚
*   **Cloudflare Worker**: ä½äºè‡ªç”±è´¸æ˜“åŒºçš„ä¸­è½¬ç«™å·¥ä½œäººå‘˜ã€‚
*   **UUID**: æ‚¨çš„ä¸“å±å°ç« /é€šè¡Œè¯ã€‚
*   **ProxyIP**: ç§˜å¯†å¿«é€’å‘˜ã€‚

### æµç¨‹æ‹†è§£

#### 1. å°è£… (The Envelope)
æ‚¨æƒ³ç»™ Google å†™ä¿¡ï¼Œä½†ä¸èƒ½ç›´æ¥å†™â€œTo: Googleâ€ï¼Œå¦åˆ™ä¼šè¢«é‚®å±€æ‹¦æˆªã€‚
*   **åŠ¨ä½œ**: æ‚¨æŠŠå†™ç»™ Google çš„ä¿¡ï¼ˆåŠ å¯†æ•°æ®ï¼‰ï¼Œè£…è¿›ä¸€ä¸ªå†™ç€ **"To: Cloudflare"** çš„æ™®é€šå•†ä¸šä¿¡å°é‡Œã€‚
*   **è®¤è¯**: æ‚¨åœ¨ä¿¡å°å£ç›–ä¸Šæ‚¨çš„ **UUID å°ç« **ã€‚åªæœ‰æ‹¥æœ‰æ ¸å¯¹åå†Œçš„ Worker æ‰èƒ½ç¡®è®¤è¿™æ˜¯æ‚¨çš„ä¿¡ã€‚
*   **åè®®**: è¿™å°±æ˜¯ **VLESS/Trojan** åè®®çš„ä½œç”¨â€”â€”ä¼ªè£…å’Œå°è£…ã€‚

#### 2. æŠ•é€’ (Transmission)
*   **åŠ¨ä½œ**: æ‚¨æŠŠä¿¡æŠ•è¿›æœ¬åœ°é‚®ç­’ã€‚
*   **æ£€æŸ¥**: é‚®å±€æ£€æŸ¥å‘˜ï¼ˆé˜²ç«å¢™ï¼‰æ‹¿èµ·ä¿¡å°ï¼Œçœ‹åˆ°æ”¶ä»¶äººæ˜¯ "Cloudflareå…¬å¸"ï¼ˆä¸€å®¶åˆæ³•çš„è·¨å›½ä¼ä¸šï¼‰ï¼Œå¹¶ä¸”ä¿¡å°çœ‹èµ·æ¥å¾ˆæ­£è§„ï¼ˆHTTPS/TLS åŠ å¯†ï¼‰ï¼Œäºæ˜¯æ”¾è¡Œã€‚
*   **ç»“æœ**: æ‚¨çš„ä¿¡æˆåŠŸé£è¶Šäº†å°é”çº¿ï¼Œåˆ°è¾¾äº† Cloudflare çš„ä»“åº“ã€‚

#### 3. åˆ†æ‹£ (Sorting - The Worker)
*   **æ¥æ”¶**: Cloudflare çš„ Worker æ”¶åˆ°ä¿¡ã€‚
*   **éªŒè¯**: Worker é¦–å…ˆæ£€æŸ¥ **UUID å°ç« **ã€‚
    *   *å°ç« é”™è¯¯?* -> ç›´æ¥ä¸¢å¼ƒæˆ–é€€å›ï¼ˆæ‹’ç»è¿æ¥ï¼‰ã€‚
    *   *å°ç« æ­£ç¡®?* -> æ‰“å¼€å¤–å±‚ä¿¡å°ã€‚
*   **è¯»å–**: Worker æ‹¿å‡ºé‡Œé¢çš„ä¿¡ï¼Œçœ‹åˆ°çœŸæ­£çš„æ”¶ä»¶äººæ˜¯ **"Google"**ã€‚

#### 4. æ´¾é€ (Delivery Methods)
è¿™æ—¶å€™ï¼ŒWorker æœ‰ä¸¤ç§æ´¾é€æ–¹å¼ï¼ˆå–å†³äºæ‚¨çš„é…ç½®ï¼‰ï¼š

*   **ğŸ…°ï¸ äº²è‡ªé€è¾¾ (Native Mode)**
    *   Worker ç›´æ¥èµ°å‡ºä»“åº“ï¼Œæ•²å¼€ Google çš„é—¨ï¼ŒæŠŠä¿¡äº¤ç»™å®ƒã€‚
    *   *ç‰¹ç‚¹*: é€Ÿåº¦å¿«ï¼Œä½† Google çœ‹åˆ°çš„æ˜¯ Worker çš„è„¸ï¼ˆCloudflare IPï¼‰ã€‚

*   **ğŸ…±ï¸ ç§˜å¯†å¿«é€’ (ProxyIP Mode)**
    *   Worker è§‰å¾—ç›´æ¥å»ä¸å®‰å…¨ï¼ˆæˆ–è€… Google ä¸å–œæ¬¢ Cloudflare çš„äººï¼‰ï¼Œäºæ˜¯ä»–æŠŠä¿¡äº¤ç»™äº†ä¸€ä½**ç§˜å¯†å¿«é€’å‘˜ (ProxyIP)**ã€‚
    *   å¿«é€’å‘˜æ‹¿ç€ä¿¡å»é€ç»™ Googleã€‚
    *   *ç‰¹ç‚¹*: Google çœ‹åˆ°çš„æ˜¯å¿«é€’å‘˜çš„è„¸ï¼ˆä½å®… IP / å½“åœ° IPï¼‰ï¼Œéå¸¸é€‚åˆçœ‹ Netflixã€‚

#### 5. å›ä¿¡ (The Reply)
*   Google å†™å¥½å›ä¿¡ï¼Œäº¤ç»™ Workerï¼ˆæˆ–å¿«é€’å‘˜è½¬äº¤ï¼‰ã€‚
*   Worker æŠŠå›ä¿¡è£…è¿›ä¸€ä¸ª **"From: Cloudflare"** çš„ä¿¡å°ã€‚
*   ä¿¡å°å›åˆ°æ‚¨çš„æ‰‹ä¸­ã€‚é‚®å±€æ£€æŸ¥å‘˜åªçœ‹åˆ°æ‚¨æ”¶åˆ°äº†ä¸€å°æ¥è‡ª Cloudflare çš„å•†åŠ¡ä¿¡ä»¶ã€‚

---

## æ ¸å¿ƒæ¶æ„ä¸æµé‡æµå‘ (System Architecture)

ç†è§£æµé‡å¦‚ä½•æµåŠ¨æ˜¯é…ç½®çš„å…³é”®ã€‚CFnew æ”¯æŒå››ç§ä¸»è¦çš„æµé‡æ¨¡å¼ã€‚

### 1. åŸç”Ÿæ¨¡å¼ (Native Mode)
*é€‚ç”¨: VLESS, Trojan, VLESS gRPC, xhttp*
Worker ç›´æ¥å¤„ç†æµé‡å¹¶è®¿é—®äº’è”ç½‘ã€‚é€Ÿåº¦æœ€å¿«ï¼Œä½† IP ä¸º Cloudflare æ•°æ®ä¸­å¿ƒ IPã€‚

```mermaid
graph LR
    Client(å®¢æˆ·ç«¯) -->|åŠ å¯†æµé‡| CF_Edge(Cloudflareè¾¹ç¼˜èŠ‚ç‚¹)
    CF_Edge -->|è§¦å‘| Worker(CFnewè„šæœ¬)
    Worker -->|è§£å¯† & è¯·æ±‚| Target(ç›®æ ‡ç½‘ç«™/YouTube)
```

### 2. ProxyIP æ¨¡å¼ (Relay Mode)
*é€‚ç”¨: VLESS, Trojan (é…åˆ p å˜é‡)*
Worker æ¥æ”¶è¯·æ±‚åï¼Œé€šè¿‡ TCP è½¬å‘ç»™æŒ‡å®šçš„ ProxyIPï¼Œç”± ProxyIP è®¿é—®ç›®æ ‡ã€‚ç”¨äºè§£é”æµåª’ä½“æˆ–éšè— Worker IPã€‚

```mermaid
graph LR
    Client(å®¢æˆ·ç«¯) -->|åŠ å¯†æµé‡| CF_Edge
    CF_Edge -->|è§¦å‘| Worker
    Worker -->|TCPè½¬å‘| ProxyIP(ä¸­è½¬æœåŠ¡å™¨)
    ProxyIP -->|è¯·æ±‚| Target(Netflix/ChatGPT)
```

### 3. Link-Only ç›´è¿æ¨¡å¼ (Direct)
*é€‚ç”¨: TUIC, Hysteria 2*
Worker **ä»…ä½œä¸ºè®¢é˜…ç”Ÿæˆå™¨**ã€‚æµé‡**ä¸ç»è¿‡** Cloudflareï¼Œç›´æ¥è¿æ¥æ‚¨çš„åç«¯æœåŠ¡å™¨ã€‚

```mermaid
graph LR
    Client(å®¢æˆ·ç«¯) -->|è·å–é…ç½®| Worker(ä»…ç”Ÿæˆé“¾æ¥)
    Client -->|UDPæµé‡| Backend(æ‚¨çš„æœåŠ¡å™¨: Hysteria2/TUIC)
```

### 4. Link-Only è½¬å‘æ¨¡å¼ (Relay)
*é€‚ç”¨: VMess, Shadowsocks (é…åˆ evm/ess å˜é‡)*
Worker å»ºç«‹ WebSocket è¿æ¥è½¬å‘æµé‡åˆ°æ‚¨çš„åç«¯æœåŠ¡å™¨ã€‚

```mermaid
graph LR
    Client(å®¢æˆ·ç«¯) -->|WSæµé‡| CF_Edge
    CF_Edge -->|è§¦å‘| Worker
    Worker -->|WSè½¬å‘| Backend(æ‚¨çš„æœåŠ¡å™¨: VMess/SS)
```

---

## é…ç½®ç™¾ç§‘å…¨ä¹¦ (Configuration Encyclopedia)

è¿™é‡ŒåŒ…å«ä»£ç ä¸­æ‰€æœ‰å¯ç”¨çš„é…ç½®å˜é‡ã€‚
**ä¼˜å…ˆçº§**: KV (å›¾å½¢ç•Œé¢) > ç¯å¢ƒå˜é‡ (Settings)ã€‚

### 1. èº«ä»½ä¸è®¤è¯ (Identity)

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
| :--- | :--- | :--- | :--- | :--- |
| **`u`** | String | (å¿…éœ€) | **UUID**ã€‚ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿æ¥æ—¶çš„å¯†ç ã€‚ | `84439981-04b6...` |
| **`tp`** | String | `u` | **Trojan Password**ã€‚Trojan åè®®ä¸“ç”¨çš„å¯†ç ã€‚ç•™ç©ºåˆ™ä½¿ç”¨ UUIDã€‚ | `mysecurepass` |

### 2. ç½‘ç»œä¸ä¸­ç»§ (Network & Relay)

| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
| :--- | :--- | :--- | :--- | :--- |
| **`p`** | String | (ç©º) | **ProxyIP**ã€‚æµé‡è½¬å‘ç›®æ ‡ (IP:Port)ã€‚ç”¨äºè§£é”/éšè— IPã€‚ | `1.2.3.4` |
| **`s`** | String | (ç©º) | **SOCKS5**ã€‚æ ¼å¼ `user:pass@host:port`ã€‚ä¼˜å…ˆçº§é«˜äº `p`ã€‚ | `u:p@1.1.1.1:1080` |
| **`d`** | String | (ç©º) | **è‡ªå®šä¹‰è·¯å¾„**ã€‚è®¾ç½®åï¼Œå¿…é¡»é€šè¿‡ `domain.com/è·¯å¾„` è®¿é—®é¢æ¿ã€‚ | `/secret` |
| **`wk`** | String | (è‡ªåŠ¨) | **Worker Region**ã€‚å¼ºåˆ¶æŒ‡å®š Worker åœ°åŒº (å¦‚ SG, US)ã€‚ | `SG` |

### 3. åè®®å¼€å…³ (Protocols)

è®¾ç½®ä¸º `yes` å¼€å¯ï¼Œ`no` å…³é—­ã€‚

| å˜é‡å | åè®® | ç±»å‹ | è¯´æ˜ | ä¾èµ– |
| :--- | :--- | :--- | :--- | :--- |
| **`ev`** | VLESS | Native | æœ€è½»é‡ï¼Œæ— çŠ¶æ€ï¼Œæ€§èƒ½æœ€ä½³ã€‚ | - |
| **`et`** | Trojan | Native | æ¨¡æ‹Ÿ HTTPS æµé‡ï¼ŒæŠ—å¹²æ‰°å¼ºã€‚ | - |
| **`ex`** | xhttp | Native | åŸºäº HTTP POST çš„ä¼ªè£…åè®®ã€‚ | éœ€ gRPC æ”¯æŒ |
| **`eg`** | VLESS gRPC | Native | ä½¿ç”¨ gRPC ä¼ è¾“ã€‚ | éœ€å®¢æˆ·ç«¯æ”¯æŒ |
| **`evm`** | VMess | Relay | ä»…ç”Ÿæˆé“¾æ¥ã€‚éœ€è‡ªå»ºåç«¯ã€‚ | åç«¯æœåŠ¡å™¨ |
| **`ess`** | Shadowsocks | Relay | ä»…ç”Ÿæˆé“¾æ¥ã€‚éœ€è‡ªå»ºåç«¯ã€‚ | åç«¯æœåŠ¡å™¨ |
| **`etu`** | TUIC | Direct | ä»…ç”Ÿæˆé“¾æ¥ã€‚UDP åè®®ã€‚ | åç«¯æœåŠ¡å™¨ |
| **`ehy`** | Hysteria 2 | Direct | ä»…ç”Ÿæˆé“¾æ¥ã€‚UDP åè®®ã€‚ | åç«¯æœåŠ¡å™¨ |
| **`ech`** | ECH | - | å¯ç”¨ Encrypted Client Helloã€‚ | éœ€ DoH æ”¯æŒ |

### 4. é€»è¾‘æ§åˆ¶ (Logic Control)

| å˜é‡å | åŠŸèƒ½ | é»˜è®¤ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **`rm`** | Region Match | `yes` | **åœ°åŒºåŒ¹é…**ã€‚æ˜¯å¦æ ¹æ®è®¿é—®è€… IP è‡ªåŠ¨åŒ¹é…æœ€è¿‘çš„ Worker èŠ‚ç‚¹ã€‚ |
| **`qj`** | Downgrade | `yes` | **é™çº§æ§åˆ¶**ã€‚è®¾ä¸º `no` å¼€å¯è‡ªåŠ¨æ•…éšœè½¬ç§» (CFç›´è¿ -> ProxyIP)ã€‚ |
| **`dkby`** | Port Filter | `no` | **ç«¯å£è¿‡æ»¤**ã€‚è®¾ä¸º `yes` åˆ™åªç”Ÿæˆ TLS (443ç­‰) èŠ‚ç‚¹ï¼Œå±è”½é TLS (80ç­‰)ã€‚ |
| **`yxby`** | Prefer Filter | `no` | **ä¼˜é€‰è¿‡æ»¤**ã€‚è®¾ä¸º `yes` åˆ™**ç¦ç”¨**æ‰€æœ‰ä¼˜é€‰ IPï¼Œåªä¿ç•™åŸç”Ÿåœ°å€ã€‚ |
| **`ae`** | API Enable | `no` | **API å¼€å…³**ã€‚è®¾ä¸º `yes` å…è®¸é€šè¿‡ API ä¿®æ”¹é…ç½®/IPã€‚ |
| **`scu`** | SubConverter | (å†…ç½®) | **è®¢é˜…è½¬æ¢åç«¯**ã€‚ç”¨äºå°† VLESS é“¾æ¥è½¬æ¢ä¸º Clash/Surge æ ¼å¼ã€‚ |
| **`homepage`** | Camouflage | (ç©º) | **ä¼ªè£…é¦–é¡µ**ã€‚è®¿é—®æ ¹è·¯å¾„ `/` æ—¶æ˜¾ç¤ºçš„å†…å®¹ URLã€‚ |

### 5. ä¼˜é€‰ä¸é«˜çº§ (Preferred & Advanced)

| å˜é‡å | è¯´æ˜ | é»˜è®¤ |
| :--- | :--- | :--- |
| **`yx`** | **è‡ªå®šä¹‰ä¼˜é€‰ IP åˆ—è¡¨**ã€‚æœ€é«˜ä¼˜å…ˆçº§ã€‚æ ¼å¼: `IP:Port#å¤‡æ³¨`ã€‚ | - |
| **`yxURL`** | **ä¼˜é€‰ IP è¿œç¨‹æº**ã€‚è¦†ç›–å†…ç½®æºã€‚æŒ‡å‘ä¸€ä¸ª TXT æ–‡ä»¶ã€‚ | (å†…ç½®æº) |
| **`epd`** | æ˜¯å¦å¯ç”¨å†…ç½®çš„**ä¼˜é€‰åŸŸå**åˆ—è¡¨ã€‚ | `no` |
| **`epi`** | æ˜¯å¦å¯ç”¨**åŠ¨æ€ä¼˜é€‰ IP** (wetest)ã€‚ | `true` |
| **`egi`** | æ˜¯å¦å¯ç”¨ **GitHub** ä¼˜é€‰æºã€‚ | `true` |
| **`ipv4`** | æ˜¯å¦è·å– IPv4 ä¼˜é€‰ IPã€‚ | `yes` |
| **`ipv6`** | æ˜¯å¦è·å– IPv6 ä¼˜é€‰ IPã€‚ | `yes` |
| **`ispMobile`** | æ˜¯å¦åŒ…å«**ä¸­å›½ç§»åŠ¨**ä¼˜é€‰ IPã€‚ | `yes` |
| **`ispTelecom`**| æ˜¯å¦åŒ…å«**ä¸­å›½ç”µä¿¡**ä¼˜é€‰ IPã€‚ | `yes` |
| **`ispUnicom`** | æ˜¯å¦åŒ…å«**ä¸­å›½è”é€š**ä¼˜é€‰ IPã€‚ | `yes` |
| **`customDNS`** | ECH æŸ¥è¯¢ç”¨çš„ DoH åœ°å€ã€‚ | `https://dns.joeyblog.eu.org/joeyblog` |
| **`customECHDomain`** | ECH ç›®æ ‡é…ç½®åŸŸåã€‚ | `cloudflare-ech.com` |

---

## åè®®æ·±åº¦è§£æ (Protocol Deep Dive)

### Native vs Link-Only

*   **Native (åŸç”Ÿå¤„ç†)**: Worker æ‹¥æœ‰å®Œæ•´çš„åè®®æ ˆï¼Œå¯ä»¥ç›´æ¥è§£å¯†å’Œå¤„ç†æµé‡ã€‚
    *   *ä¼˜åŠ¿*: æ— éœ€é¢å¤–æœåŠ¡å™¨ï¼Œå…è´¹ï¼Œé€Ÿåº¦å¿«ã€‚
    *   *åŠ£åŠ¿*: å—é™äº Cloudflare Worker ç¯å¢ƒ (æ—  UDP ç›‘å¬ï¼Œç«¯å£å—é™)ã€‚
*   **Link-Only (ä»…é“¾æ¥)**: Worker ä»…ä½œä¸ºé…ç½®åˆ†å‘ä¸­å¿ƒã€‚å®é™…çš„æµé‡å¤„ç†ç”±æ‚¨è‡ªå·±çš„ VPS å®Œæˆã€‚
    *   *ä¸ºä»€ä¹ˆéœ€è¦?*: Cloudflare Workers **ä¸æ”¯æŒ** UDP ç›‘å¬ï¼Œå› æ­¤æ— æ³•è¿è¡Œ Hysteria 2 æˆ– TUIC æœåŠ¡ç«¯ã€‚
    *   *æµé‡èµ°å‘*: å®¢æˆ·ç«¯ -> æ‚¨çš„ VPS (Worker æ­¤æ—¶åªæ˜¯ä¸€å¼ å†™ç€åœ°å€çš„çº¸æ¡)ã€‚

### ECH æŠ€æœ¯è¯¦è§£

**Encrypted Client Hello (ECH)** æ˜¯ä¸€é¡¹æ—¨åœ¨åŠ å¯† TLS æ¡æ‰‹é˜¶æ®µ (Client Hello) çš„æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯åŠ å¯† **SNI (Server Name Indication)**ã€‚

1.  **é—®é¢˜**: ä¼ ç»Ÿ TLS æ¡æ‰‹ä¸­ï¼ŒSNI æ˜¯æ˜æ–‡çš„ã€‚é˜²ç«å¢™å¯ä»¥çœ‹åˆ°æ‚¨è®¿é—®äº† `google.com` å¹¶é˜»æ–­è¿æ¥ã€‚
2.  **è§£å†³**: ECH å°† SNI åŠ å¯†ã€‚é˜²ç«å¢™åªèƒ½çœ‹åˆ°æ‚¨è¿æ¥åˆ°äº† Cloudflareï¼Œä½†ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªç½‘ç«™ã€‚
3.  **Worker å®ç°**:
    *   Worker ä½¿ç”¨ `customDNS` (å¿…é¡»æ˜¯ DoH HTTPS åœ°å€) æŸ¥è¯¢ `customECHDomain` çš„ ECH é…ç½®ã€‚
    *   Worker å°†æ­¤é…ç½®æ³¨å…¥åˆ°ç”Ÿæˆçš„ VLESS/Trojan é“¾æ¥ä¸­ã€‚
    *   å®¢æˆ·ç«¯ä½¿ç”¨æ­¤é…ç½®åŠ å¯†æ¡æ‰‹ä¿¡æ¯ã€‚

---

## ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ (Scenarios)

### åœºæ™¯ 1: æµåª’ä½“è§£é” (Netflix/Disney+)
ç›®æ ‡: è§‚çœ‹ä»…é™ç‰¹å®šåœ°åŒºçš„å†…å®¹ã€‚
1.  æ‰¾åˆ°ä¸€ä¸ªæ”¯æŒè§£é”çš„ ProxyIP (ä¾‹å¦‚æ–°åŠ å¡çš„ IP)ã€‚
2.  åœ¨ KV ä¸­è®¾ç½® `p = 1.2.3.4:443` (ProxyIP åœ°å€)ã€‚
3.  è®¾ç½® `wk = SG` (å¼ºåˆ¶åŒ¹é…æ–°åŠ å¡åœ°åŒºï¼Œå‡å°‘å»¶è¿Ÿ)ã€‚
4.  å®¢æˆ·ç«¯è¿æ¥ -> Worker -> ProxyIP (æ–°åŠ å¡) -> Netflixã€‚

### åœºæ™¯ 2: æè‡´éšè”½ä¸å®‰å…¨ (Paranoid Mode)
ç›®æ ‡: é˜²æ­¢æ¢æµ‹ï¼Œé˜²æ­¢ SNI é˜»æ–­ã€‚
1.  è®¾ç½® `d = /my-super-secret-path`ã€‚è¿™æ ·åªæœ‰çŸ¥é“è·¯å¾„çš„äººæ‰èƒ½çœ‹åˆ°é¢æ¿ã€‚
2.  è®¾ç½® `ech = yes`ã€‚åŠ å¯† SNIï¼Œé˜²ç«å¢™æ— æ³•é€šè¿‡ SNI è¯†åˆ«ç›®æ ‡ã€‚
3.  è®¾ç½® `tp = å¼ºå¯†ç `ã€‚å³ä½¿ UUID æ³„éœ²ï¼ŒTrojan åè®®ä¹Ÿæœ‰ç¬¬äºŒå±‚ä¿æŠ¤ã€‚
4.  è®¾ç½® `homepage = https://www.microsoft.com`ã€‚ç›´æ¥è®¿é—®æ ¹åŸŸåæ˜¾ç¤ºå¾®è½¯é¦–é¡µã€‚

### åœºæ™¯ 3: æ··åˆéƒ¨ç½² (Hybrid)
ç›®æ ‡: å…¼é¡¾é€Ÿåº¦ä¸ UDP æ¸¸æˆæ€§èƒ½ã€‚
1.  å¼€å¯ `ev = yes` (VLESS) ç”¨äºæ—¥å¸¸ç½‘é¡µæµè§ˆ (Cloudflare CDN åŠ é€Ÿ)ã€‚
2.  å¼€å¯ `ehy = yes` (Hysteria 2) å¹¶æŒ‡å‘æ‚¨çš„ VPSã€‚
3.  åœ¨å®¢æˆ·ç«¯åŒæ—¶æ·»åŠ è¿™ä¸¤ä¸ªèŠ‚ç‚¹ã€‚
    *   çœ‹è§†é¢‘/ä¸‹è½½ç”¨ VLESS (çœæµé‡ï¼ŒCDN åŠ é€Ÿ)ã€‚
    *   æ‰“æ¸¸æˆ/è¯­éŸ³é€šè¯ç”¨ Hysteria 2 (UDP ä½å»¶è¿Ÿ)ã€‚

---

## ä»é›¶å¼€å§‹å®‰è£… (Zero to Hero)

### 1. éƒ¨ç½² Worker
1.  ç™»å½• Cloudflare Dash -> **Workers & Pages** -> **Create Worker**.
2.  å‘½å (å¦‚ `cf-proxy`) -> **Deploy**.
3.  **Edit Code** -> ç²˜è´´ `snippets` æˆ– `_worker.js` å†…å®¹ -> **Save and deploy**.

### 2. é…ç½® KV (å¿…é¡»!)
1.  **Workers & Pages** -> **KV** -> **Create Namespace** -> å‘½åä¸º `CONFIG` -> **Add**.
2.  å›åˆ° Worker -> **Settings** -> **Variables** -> **KV Namespace Bindings**.
3.  Add binding -> Variable name: `C` (å¤§å†™) -> Namespace: `CONFIG` -> **Save**.

### 3. åˆå§‹åŒ–
1.  **Settings** -> **Variables** -> **Environment Variables**.
2.  æ·»åŠ å˜é‡ `u` = `æ‚¨çš„UUID`.
3.  è®¿é—® `https://æ‚¨çš„åŸŸå/æ‚¨çš„UUID` è¿›å…¥é¢æ¿ã€‚

---

## å®¢æˆ·ç«¯é…ç½®æŒ‡å—

ä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒï¼Œè¯·æ³¨æ„ä»¥ä¸‹å®¢æˆ·ç«¯è®¾ç½®ï¼š

### v2rayNG (Android)
*   **Mux (å¤šè·¯å¤ç”¨)**: å»ºè®®**å…³é—­**ã€‚è™½ç„¶ç†è®ºä¸Šèƒ½é™ä½æ¡æ‰‹å»¶è¿Ÿï¼Œä½†åœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹ä¼šå¯¼è‡´æ–­æµã€‚
*   **è·³è¿‡è¯ä¹¦éªŒè¯**: å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰åŸŸåï¼Œå»ºè®®è®¾ä¸º `true` (å…è®¸ä¸å®‰å…¨)ã€‚
*   **Sniffing (æµé‡å—…æ¢)**: å»ºè®®**å¼€å¯**ï¼Œä»¥ä¾¿æ­£ç¡®åˆ†æµå›½å†…å¤–æµé‡ã€‚

### Shadowrocket (iOS)
*   **Allow Insecure**: åœ¨è®¾ç½®ä¸­å¼€å¯ã€‚
*   **è®¢é˜…æ›´æ–°**: å»ºè®®å¼€å¯ "æ‰“å¼€æ—¶æ›´æ–°"ï¼Œç¡®ä¿è·å¾—æœ€æ–°çš„ä¼˜é€‰ IPã€‚

### Clash Meta / Mihomo (PC/Android)
*   **å†…æ ¸**: è¯·åŠ¡å¿…ä½¿ç”¨ Meta (Mihomo) å†…æ ¸ã€‚å®˜æ–¹ Premium å†…æ ¸å¯èƒ½ä¸æ”¯æŒ VLESS Reality æˆ–æŸäº› ECH ç‰¹æ€§ã€‚
*   **Client Fingerprint**: å»ºè®®è®¾ç½®ä¸º `chrome`ï¼Œæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨æŒ‡çº¹ã€‚

---

## æ•…éšœæ’é™¤ (Troubleshooting)

| é”™è¯¯ä»£ç  | å¸¸è§åŸå›  | è§£å†³æ–¹æ¡ˆ |
| :--- | :--- | :--- |
| **1101** | Worker è„šæœ¬å¼‚å¸¸ | 1. æ£€æŸ¥ KV æ˜¯å¦ç»‘å®šä¸ºå˜é‡ `C`ã€‚<br>2. æ£€æŸ¥ä»£ç æ˜¯å¦å®Œæ•´å¤åˆ¶ã€‚ |
| **1033** | Argo Tunnel é”™è¯¯ | é€šå¸¸ä¸ Worker æ— å…³ï¼Œæ˜¯ Cloudflare å†…éƒ¨ç½‘ç»œæ³¢åŠ¨ï¼Œç¨åé‡è¯•ã€‚ |
| **502** | Bad Gateway | **ProxyIP å¤±æ•ˆ**ã€‚Worker æ— æ³•è¿æ¥åˆ°æ‚¨è®¾ç½®çš„ `p` åœ°å€ã€‚è¯·æ›´æ¢æˆ–æ¸…ç©º `p`ã€‚ |
| **522** | Connection Timed Out | **è¿æ¥è¶…æ—¶**ã€‚Worker æ— æ³•è¿æ¥åˆ°æºç«™ã€‚å¯èƒ½æ˜¯ IP è¢«å¢™æˆ–ç«¯å£æœªå¼€æ”¾ã€‚ |
| **èŠ‚ç‚¹è¶…æ—¶** | ç½‘ç»œä¸é€š | 1. æ£€æŸ¥ `u` (UUID) æ˜¯å¦åŒ¹é…ã€‚<br>2. æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¼€å¯ TLSã€‚<br>3. å°è¯•ä½¿ç”¨ä¼˜é€‰ IPã€‚ |

---

## API ç®¡ç†

**Base URL**: `https://æ‚¨çš„åŸŸå/æ‚¨çš„è·¯å¾„/api/preferred-ips`

### 1. è·å–æ‰€æœ‰ IP
```bash
curl -X GET https://domain.com/uuid/api/preferred-ips
```

### 2. æ·»åŠ  IP
```bash
curl -X POST https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4", "port": 443, "name": "SG-Optimized"}'
```

### 3. åˆ é™¤ IP
```bash
curl -X DELETE https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4"}'
```

### 4. æ¸…ç©ºæ‰€æœ‰
```bash
curl -X DELETE https://domain.com/uuid/api/preferred-ips \
  -H "Content-Type: application/json" \
  -d '{"all": true}'
```

---

## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=byJoey/cfnew&type=Timeline)](https://www.star-history.com/#byJoey/cfnew&Timeline&LogScale)
