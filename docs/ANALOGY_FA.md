# قیاس و درک عمیق

این سند با یک قیاس ساده CFnew را توضیح می‌دهد و اجزای واقعی را مشخص می‌کند.

---

## قیاس اداره پست امن

فرض کنید در کشوری زندگی می‌کنید که نامه‌ها به‌شدت بازرسی می‌شوند.

### 1) آدرس پوششی (Cloudflare)
- می‌خواهید نامه‌ای به سایتی مسدود بفرستید.
- روی پاکت آدرس **Cloudflare** می‌نویسید.
- بازرس با دیدن Cloudflare آن را عبور می‌دهد.

### 2) مهر نامرئی (UUID)
- پشت پاکت یک مهر نامرئی می‌زنید (UUID).
- در مرکز Cloudflare (Worker) این مهر بررسی می‌شود:
  - **بدون مهر** → صفحه وب عادی
  - **مهر معتبر** → ترافیک پروکسی

### 3) پیک مورد اعتماد (ProxyIP)
- گاهی بازرس روی IP خروجی حساس است.
- ProxyIP مثل یک پیک است که IP واقعی را پنهان می‌کند.

### 4) پاکت داخلی مهر و موم‌شده (ECH)
- ECH برچسب داخلی (SNI) را رمز می‌کند.
- شناسایی مقصد واقعی سخت‌تر می‌شود.

---

## نگاشت قیاس به اجزا

| قیاس | جزء در CFnew |
|---|---|
| نامه | ترافیک کلاینت |
| آدرس Cloudflare | دامنه Worker |
| مهر نامرئی | UUID (`u`) |
| کارمند پست | اسکریپت Worker |
| پیک | ProxyIP (`p`) |
| پاکت داخلی | ECH (DoH + `ech`) |

---

## چرا سانسور را دور می‌زند؟

- بیرون فقط HTTPS عادی به Cloudflare دیده می‌شود.
- UUID داخل Worker بررسی می‌شود.
- ProxyIP خروجی واقعی را پنهان می‌کند.
- ECH تشخیص SNI را سخت می‌کند.

---

## نکات عملی

- UUID کلید اصلی است؛ در صورت افشا سریع تعویض کنید.
- مسیر سفارشی `d` مثل صندوق محرمانه است.
- KV کابینت تنظیمات شماست.

---

جزئیات فنی در `DNS_ENCODING.md` آمده است.
