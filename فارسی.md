# CFnew - ترمینال v2.9.3

**زبان:** [中文](README.md) | [فارسی](فارسی.md)

[گروه تلگرام](https://t.me/+ft-zI76oovgwNmRh)

## فهرست مطالب
1. [ویژگی‌های اصلی](#ویژگی‌های-اصلی)
2. [به‌روزرسانی‌ها](#به‌روزرسانی-v293)
3. [معماری سیستم](#معماری-سیستم)
4. [استقرار و پیکربندی](#استقرار-و-پیکربندی-دقیق)
   - [پیکربندی پایه (Environment Variables)](#۱-پیکربندی-پایه-environment-variables)
   - [پیکربندی پروتکل‌ها](#۲-پیکربندی-پروتکل‌ها)
   - [پیکربندی گرافیکی (KV)](#۳-پیکربندی-گرافیکی-kv---توصیه-می‌شود)
   - [کنترل پیشرفته](#۴-کنترل-پیشرفته-و-سرورهای-ترجیحی)
5. [تحلیل عمیق ProxyIP](#تحلیل-عمیق-proxyip)
6. [توضیحات پروتکل‌ها](#توضیحات-پروتکل‌ها-و-فقط-تولید-لینک)
7. [عیب‌یابی (Troubleshooting)](#عیب‌یابی-troubleshooting)
8. [استفاده از API](#راهنمای-مدیریت-api)
9. [قابلیت ECH](#قابلیت-ech-encrypted-client-hello)
10. [تاریخچه ستاره](#تاریخچه-ستاره)

---

## ویژگی‌های اصلی

- **پشتیبانی چند پروتکل**: VLESS، Trojan، xhttp، VMess، Shadowsocks، TUIC، Hysteria 2، VLESS gRPC؛ می‌توانید همزمان چند پروتکل را فعال کنید.
- **مسیر سفارشی (Path)**: امکان تنظیم مسیر دلخواه (به جای UUID) برای مخفی‌سازی بیشتر پنل مدیریت.
- **تست تاخیر**: ابزار داخلی وب برای تست تاخیر سرور (IP) و دریافت خودکار کد فرودگاه.
- **تبدیل اشتراک (Subscription Convert)**: پشتیبانی از سرویس‌های تبدیل اشتراک برای کلاینت‌های مختلف (Clash, Surge).
- **مدیریت گرافیکی**: ذخیره‌سازی تنظیمات در KV Cloudflare با اعمال آنی تغییرات بدون نیاز به استقرار مجدد.
- **مدیریت API**: مدیریت سرورهای ترجیحی (Preferred IPs) از طریق RESTful API.
- **DoH داخلی**: سرویس DNS-over-HTTPS داخلی با کارایی بالا و پشتیبانی از حذف تبلیغات.
- **پشتیبانی چند کلاینت**: شناسایی خودکار User-Agent و ارائه کانفیگ مناسب برای CLASH، SURGE، SING-BOX، V2RAY و غیره.
- **بیدار کردن برنامه**: باز کردن خودکار نرم‌افزار کلاینت با کلیک روی دکمه در پنل وب.
- **پشتیبانی چند زبان**: تغییر خودکار بین چینی و فارسی بر اساس زبان مرورگر با پشتیبانی کامل RTL.

## به‌روزرسانی v2.9.4 (جدید)

- **گسترش پروتکل‌ها**: اضافه شدن پشتیبانی از VMess، Shadowsocks، TUIC، Hysteria 2 و VLESS gRPC.
- **سرویس DoH**: اضافه شدن پروکسی DNS-over-HTTPS داخلی با قابلیت لود بالانسینگ و حذف تبلیغات.

## به‌روزرسانی v2.9.3

- **ویژگی جدید سفارشی‌سازی DNS و دامنه ECH در رابط گرافیکی**
  - امکان تنظیم دستی آدرس سرور DNS (فرمت DoH).
  - امکان تنظیم دستی دامنه ECH.
  - اعمال تغییرات به صورت پویا و آنی.
  - اضافه شدن پارامتر `query-server-name` به `ech-opts` در پیکربندی Clash برای هماهنگی با v2ray.

---

## معماری سیستم

اسکریپت CFnew Worker به عنوان یک دروازه هوشمند عمل می‌کند که درخواست‌های کلاینت را پردازش و هدایت می‌کند.

```
کلاینت (Clash/V2Ray)
   | (VLESS/Trojan over TLS)
   v
شبکه لبه Cloudflare (Worker)
   |
   +---(اتصال مستقیم)----------> وب‌سایت هدف (YouTube, Google...)
   |
   +---(بازارسال)--> ProxyIP ---> وب‌سایت هدف (مخفی کردن IP Worker)
   |
   +---(SOCKS5)--> SOCKS5 پروکسی -> وب‌سایت هدف (زنجیره پروکسی)
```

**جریان کار**:
1. کاربر لینک اشتراک را دریافت می‌کند -> Worker تنظیمات را تولید می‌کند (شامل IPهای بهینه یا دامنه Worker).
2. کلاینت به Worker متصل می‌شود -> Worker هدر پروتکل VLESS/Trojan را پردازش می‌کند.
3. Worker بر اساس تنظیمات (`p` یا `s`) تصمیم می‌گیرد که مستقیماً به هدف وصل شود یا از طریق واسط.

---

## استقرار و پیکربندی دقیق

اشتراک هر ۱۵ دقیقه یکبار به صورت خودکار سرورهای بهینه را به‌روزرسانی می‌کند.

### ۱. پیکربندی پایه (Environment Variables)

این متغیرها را در بخش "Settings" -> "Variables" در Worker خود تنظیم کنید.

<div dir="rtl">

| نام متغیر | مثال مقدار | توضیحات |
| :--- | :--- | :--- |
| `u` | `84439981-04b6-4103-aa4b-864aa9c91469` | **الزامی**. شناسه UUID شما. برای احراز هویت و مسیر پیش‌فرض دسترسی به پنل. حتماً از یک UUID معتبر استفاده کنید. |
| `p` | `1.2.3.4` یا `ProxyIP.example.com` | **اختیاری (بسیار توصیه می‌شود)**. ProxyIP (آدرس سرور واسط).<br>1. **مخفی کردن IP منبع**: جلوگیری از افشای IP مستقیم Worker به وب‌سایت هدف.<br>2. **حل محدودیت CF**: رفع خطای "Cloudflare Loop" یا وب‌سایت‌هایی که IPهای Cloudflare را مسدود کرده‌اند.<br>3. **فرمت**: `IP:Port` یا `Domain:Port`. |
| `s` | `user:pass@1.2.3.4:1080` | **اختیاری**. آدرس پروکسی SOCKS5. Worker به عنوان کلاینت به این SOCKS5 متصل شده و سپس به هدف می‌رود. مناسب برای تغییر IP خروجی به یک کشور خاص. |
| `d` | `/my-secret-path` | **اختیاری**. مسیر سفارشی. با تنظیم این مقدار، دسترسی از طریق UUID غیرفعال شده و فقط از طریق این مسیر امکان‌پذیر است. (افزایش امنیت و جلوگیری از اسکن شدن). |
| `wk` | `SG`, `HK`, `US` | **اختیاری**. کد منطقه Worker. اسکریپت تلاش می‌کند IPهای بهینه مربوط به این منطقه را انتخاب کند تا به نزدیک‌ترین نود Cloudflare متصل شوید. |

</div>

### ۲. پیکربندی پروتکل‌ها

<div dir="rtl">

| نام متغیر | پیش‌فرض | توضیحات |
| :--- | :--- | :--- |
| `ev` | `yes` | فعال‌سازی پروتکل **VLESS** (WS + TLS). پروتکل اصلی، سریع‌ترین عملکرد، پیشنهاد می‌شود همیشه روشن باشد. |
| `et` | `no` | فعال‌سازی پروتکل **Trojan**. نیاز به UUID ندارد، فقط رمز عبور. سازگاری بالا با اکثر کلاینت‌ها. |
| `ex` | `no` | فعال‌سازی پروتکل **xhttp** (مبتنی بر HTTP POST). **توجه**: نیاز به فعال‌سازی gRPC در داشبورد Cloudflare و اتصال دامنه سفارشی دارد. |
| `evm` | `no` | فعال‌سازی **VMess** (فقط تولید لینک). ترافیک از طریق WebSocket به `p` یا `s` منتقل می‌شود. |
| `ess` | `no` | فعال‌سازی **Shadowsocks** (فقط تولید لینک). مشابه VMess، نیاز به سرور واسط دارد. |
| `etu` | `no` | فعال‌سازی **TUIC** (فقط تولید لینک). مبتنی بر UDP. Worker نمی‌تواند پردازش کند، لینک فقط برای سرور شخصی شماست. |
| `ehy` | `no` | فعال‌سازی **Hysteria 2** (فقط تولید لینک). مشابه TUIC. |
| `eg` | `no` | فعال‌سازی **VLESS gRPC**. ترافیک از طریق gRPC منتقل می‌شود. |
| `tp` | (خالی) | رمز عبور Trojan. اگر خالی باشد از UUID استفاده می‌شود. پیشنهاد می‌شود رمز ساده‌ای انتخاب کنید. |
| `ech` | `no` | فعال‌سازی **ECH**. با روشن کردن، حالت "فقط TLS" خودکار فعال می‌شود. مقاومت بالا در برابر فیلترینگ SNI. |

</div>

### ۳. پیکربندی گرافیکی (KV - توصیه می‌شود)

این روش بهترین راه برای مدیریت تنظیمات است. تغییرات بلافاصله اعمال می‌شوند و نیازی به Deploy مجدد نیست.

1. در داشبورد Cloudflare Workers، یک **KV Namespace** ایجاد کنید (مثلاً با نام `CONFIG`).
2. در تنظیمات Worker خود (Settings -> Variables -> KV Namespace Bindings)، متغیری با نام `C` ایجاد کرده و به KV ساخته شده متصل کنید.
3. Worker را مجدداً Deploy کنید.
4. اکنون با مراجعه به `https://your-domain/{UUID}` (یا مسیر سفارشی)، پنل مدیریت گرافیکی را مشاهده خواهید کرد.

### ۴. کنترل پیشرفته و سرورهای ترجیحی

<div dir="rtl">

| نام متغیر | مثال مقدار | توضیحات |
| :--- | :--- | :--- |
| `yx` | `1.1.1.1:443#Name` | **IP/دامنه ترجیحی سفارشی**. افزودن دستی سرورها. فرمت: `IP:Port#Name`. اولویت بالاتر از همه منابع دیگر. |
| `yxURL` | `https://site.com/ips.txt` | **URL منبع IP**. دریافت لیست IPهای ترجیحی از یک فایل متنی آنلاین. جایگزین لیست پیش‌فرض می‌شود. مناسب برای به‌روزرسانی خودکار. |
| `scu` | `https://url.v1.mk/sub` | **آدرس تبدیل اشتراک**. سرویس Backend برای تبدیل فرمت به Clash/Surge. پیشنهاد می‌شود از سرویس شخصی یا مطمئن استفاده کنید. |
| `homepage` | `https://google.com` | **صفحه اصلی سفارشی**. در صورت بازدید از ریشه دامنه `/`، محتوای این آدرس نمایش داده می‌شود (استتار برای جلوگیری از شناسایی). |
| `epd` | `yes` | فعال‌سازی دامنه ترجیحی. |
| `epi` | `yes` | فعال‌سازی IP ترجیحی. |
| `egi` | `yes` | فعال‌سازی ترجیح GitHub. |
| `qj` | `no` | **حالت کاهش سطح (Fallback)**. با تنظیم `no` فعال می‌شود. منطق: اتصال مستقیم CF -> اگر شکست خورد -> SOCKS5 -> اگر شکست خورد -> ProxyIP. افزایش پایداری اتصال. |
| `dkby` | `yes` | **حالت فقط TLS**. اگر `yes` باشد، پورت‌های غیر TLS (مانند 80) حذف می‌شوند. امنیت بیشتر. |
| `customDNS` | `https://dns.google/dns-query` | **DNS سفارشی**. آدرس DoH برای دریافت تنظیمات ECH. |
| `customECHDomain` | `cloudflare-ech.com` | **دامنه ECH**. دامنه مورد استفاده برای تنظیمات ECH. |

</div>

---

## تحلیل عمیق ProxyIP

**ProxyIP چیست؟**
ProxyIP (یا IP واسط/معکوس) سروری است که بین Cloudflare Worker و وب‌سایت مقصد قرار می‌گیرد.

**چرا به آن نیاز داریم؟**
1.  **عبور از تحریم‌ها**: برخی سایت‌ها (مانند ChatGPT، Netflix) دسترسی دیتاسنترهای Cloudflare را مسدود کرده‌اند. با استفاده از ProxyIP مسکونی یا دیتاسنتر تمیز، می‌توانید این محدودیت را دور بزنید.
2.  **مخفی‌سازی هویت**: جلوگیری از اینکه وب‌سایت مقصد بفهمد ترافیک از Cloudflare Worker می‌آید.
3.  **جلوگیری از Loop**: رفع خطای "Cloudflare Loop" که زمانی رخ می‌دهد که Worker سعی می‌کند سایتی را باز کند که خودش هم روی Cloudflare است.

**چگونه پیدا کنیم؟**
-   جستجو برای "Cloudflare ProxyIP" در تلگرام یا گیت‌هاب.
-   راه‌اندازی یک Nginx/Caddy شخصی روی یک سرور مجازی (VPS) و استفاده از IP آن به عنوان `p`.

---

## توضیحات پروتکل‌ها و "فقط تولید لینک"

این اسکریپت از پروتکل‌های مختلفی پشتیبانی می‌کند، اما نحوه عملکرد آن‌ها متفاوت است:

1.  **پشتیبانی بومی (Native)**: Worker مستقیماً ترافیک این پروتکل‌ها را پردازش می‌کند.
    *   **VLESS (WS)**: استانداردترین پروتکل، سازگاری عالی.
    *   **Trojan (WS)**: شبیه‌سازی ترافیک HTTPS، شناسایی سخت‌تر.
    *   **xhttp**: پروتکل جدید با پنهان‌سازی بالا، نیازمند کلاینت‌های خاص.

2.  **فقط تولید لینک (Link Only)**: Worker فقط لینک اشتراک را می‌سازد، اما **نمی‌تواند ترافیک را پردازش کند**.
    *   **TUIC / Hysteria 2**: مبتنی بر UDP/QUIC هستند. چون Cloudflare Workers از ورودی UDP پشتیبانی نمی‌کند، این لینک‌ها فقط برای زمانی است که شما سرور جداگانه‌ای با این پروتکل‌ها دارید.
    *   **VMess / Shadowsocks**: لینک تولید می‌شود، اما ترافیک باید از طریق WebSocket Relay عبور کند. **حتماً باید `p` (ProxyIP) یا `s` (SOCKS5) تنظیم شده باشد**، در غیر این صورت اتصال برقرار نمی‌شود.

**پیشنهاد**: اگر سرور دیگری ندارید و فقط از همین Worker استفاده می‌کنید، تنها **VLESS** و **Trojan** را فعال کنید.

---

## عیب‌یابی (Troubleshooting)

**کدهای خطای رایج:**

-   **1101 (Worker Threw Exception)**: خطای داخلی کد Worker. بررسی کنید که KV به درستی متصل شده باشد و فرمت UUID صحیح باشد.
-   **502 (Bad Gateway)**:
    -   معمولاً یعنی ProxyIP (`p`) کار نمی‌کند یا فیلتر شده است. آن را تغییر دهید یا خالی بگذارید.
    -   اگر از پروتکل xhttp استفاده می‌کنید، ممکن است gRPC در Cloudflare فعال نباشد.
-   **1033 (Tunnel Error)**: خطای تونل Cloudflare. معمولاً مشکل موقتی شبکه داخلی Cloudflare است.

**مشکلات کلاینت:**

-   **Clash Meta (Mihomo)**: برای استفاده از ویژگی‌های جدید مثل VLESS Reality و ECH حتماً از هسته Meta استفاده کنید.
-   **Shadowrocket**: گزینه "Allow Insecure" را فعال کنید (اگر گواهی SSL مشکل دارد).
-   **V2RayNG**: هسته Xray را به‌روز نگه دارید.

---

## راهنمای مدیریت API

با فعال‌سازی API، می‌توانید با نوشتن اسکریپت، IPهای تمیز را به صورت خودکار به Worker اضافه کنید.

1.  **فعال‌سازی**: در پنل گرافیکی -> "کنترل پیشرفته" -> "اجازه مدیریت API (ae)" -> "بله (Yes)" را انتخاب و ذخیره کنید.
2.  **آدرس‌های API**:
    *   دریافت لیست: `GET /api/preferred-ips`
    *   افزودن: `POST /api/preferred-ips`
    *   حذف: `DELETE /api/preferred-ips`

**مثال استفاده (Bash/Curl):**

```bash
# افزودن یک سرور
curl -X POST "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '{"ip": "1.2.3.4", "port": 443, "name": "سرور جدید"}'

# پاک‌سازی کامل لیست
curl -X DELETE "https://your-worker.workers.dev/{UUID}/api/preferred-ips" \
  -H "Content-Type: application/json" \
  -d '{"all": true}'
```

---

## قابلیت ECH (Encrypted Client Hello)

ECH یک تکنولوژی جدید برای بهبود حریم خصوصی است که SNI (نام دامنه در حال بازدید) را در مرحله Handshake رمزگذاری می‌کند.

*   **فعال‌سازی**: گزینه "فعال‌سازی ECH" را در پنل تیک بزنید.
*   **عملکرد**: به طور خودکار حالت "فقط TLS" روشن می‌شود. لینک‌های اشتراک حاوی تنظیمات ECH خواهند بود.
*   **به‌روزرسانی**: با هر بار نوسازی اشتراک، Worker آخرین کلیدهای ECH را از طریق DNS (DoH) دریافت می‌کند.

---

## تاریخچه ستاره

[![نمودار تاریخچه ستاره‌های پروژه در گیت‌هاب](https://api.star-history.com/svg?repos=byJoey/cfnew&type=Timeline)](https://www.star-history.com/#byJoey/cfnew&Timeline&LogScale)

---
*تشکر ویژه از پروژه‌های [zizifn/edgetunnel](https://github.com/zizifn/edgetunnel)، [cmliu](https://github.com/cmliu) و [qwer-search](https://github.com/qwer-search).*
